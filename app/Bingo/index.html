<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è³“æœå¤§æŒ‘æˆ°</title>
    <link rel="icon" href="../../images/brother.png" type="image/png">

    <!-- å¼•å…¥ React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- å¼•å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* åŸºç¤è¨­ç½® */
        body { 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            -webkit-user-select: none;
            touch-action: pan-y;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* æ‹–æ›³æ‰‹æŠŠ */
        .drag-handle {
            cursor: grab;
            touch-action: none; 
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
        }
        .drag-handle:active { cursor: grabbing; color: #4f46e5; }

        /* æ‹–æ›³ä¸­çš„é …ç›®æ¨£å¼ */
        .task-row.is-dragging {
            background-color: #eff6ff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 2px solid #6366f1;
            transform: scale(1.02);
            z-index: 50;
            position: relative;
            opacity: 0.95;
        }

        input[type="text"], input[type="number"] { user-select: text; -webkit-user-select: text; }
        
        /* éš±è—åŸç”Ÿæ•¸å­—è¼¸å…¥æ¡†çš„ç®­é ­ (å› ç‚ºæˆ‘å€‘è‡ªå·±åšäº†æŒ‰éˆ•) */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            appearance: none; /* V21: åŠ å…¥æ¨™æº–å±¬æ€§ä»¥æ¶ˆé™¤è­¦å‘Š */
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield; /* V21: åŠ å…¥æ¨™æº–å±¬æ€§ä»¥æ¶ˆé™¤è­¦å‘Š */
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- åœ–ç¤ºå…ƒä»¶ ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Grid3X3 = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></IconBase>;
        const Check = (props) => <IconBase {...props}><path d="M20 6 9 17l-5-5"/></IconBase>;
        const Dices = (props) => <IconBase {...props}><rect width="12" height="12" x="2" y="10" rx="2" ry="2"/><path d="m17.92 14 3.5-3.5a2.24 2.24 0 0 0 0-3l-5-4.92a2.24 2.24 0 0 0-3 0L10 6"/><path d="M6 18h.01"/><path d="M10 14h.01"/><path d="M15 6h.01"/><path d="M18 9h.01"/></IconBase>;
        const Dumbbell = (props) => <IconBase {...props}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Minus = (props) => <IconBase {...props}><path d="M5 12h14"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Edit2 = (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const FolderOpen = (props) => <IconBase {...props}><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>;
        const LayoutList = (props) => <IconBase {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/><path d="M14 4h7"/><path d="M14 9h7"/><path d="M14 15h7"/><path d="M14 20h7"/></IconBase>;
        const Timer = (props) => <IconBase {...props}><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Pause = (props) => <IconBase {...props}><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const ClipboardList = (props) => <IconBase {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Volume2 = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></IconBase>;
        const VolumeX = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" x2="17" y1="9" y2="15"/><line x1="17" x2="23" y1="9" y2="15"/></IconBase>;
        const GripVertical = (props) => <IconBase {...props}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></IconBase>;
        const Sun = (props) => <IconBase {...props}><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></IconBase>;

        // --- é è¨­è³‡æ–™ ---
        const DEFAULT_LISTS = [
            {
                id: 'default-exercise',
                name: 'ğŸ’ª é‹å‹•å°æŒ‘æˆ°',
                tasks: [ "æ·±è¹² 10 æ¬¡", "å¹³æ¿æ”¯æ’ 20 ç§’", "é–‹åˆè·³ 15 ä¸‹", "åŸåœ°è¸æ­¥ 30 ç§’", "ä¼åœ°æŒºèº« 5 æ¬¡", "ç¶­æŒå–®è…³ç«™ç«‹ 10 ç§’", "ä»°è‡¥èµ·å 5 æ¬¡", "å¼“ç®­æ­¥å„ 5 æ¬¡", "ä¼¸å±•æ‰‹è‡‚ 10 ç§’", "é«˜æŠ¬è…¿ 20 ä¸‹" ]
            },
            {
                id: 'default-fun',
                name: 'ğŸ¤ª è¶£å‘³å°æŒ‘æˆ°',
                tasks: [ "èª‡çå°æ‰‹ä¸€å¥", "å”±ä¸€é¦–æ­Œçš„å‰¯æ­Œ", "åšå€‹é¬¼è‡‰", "å¤§ç¬‘ä¸‰è²", "ç”¨å±è‚¡å¯«å­—", "å­¸è²“å«ä¸‰è²", "èªªä¸€å€‹å†·ç¬‘è©±", "æ¨¡ä»¿ä¸€ç¨®å‹•ç‰©", "å‘å·¦é‚Šçš„äººæ¯”æ„›å¿ƒ", "è‡ªæ‹ä¸€å¼µé†œç…§" ]
            }
        ];

        // --- éŸ³æ•ˆå¼•æ“ ---
        let audioCtx = null;
        const playAlertSound = () => {
            try {
                if (!audioCtx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) audioCtx = new AudioContext();
                }
                if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
                if (!audioCtx) return;

                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.15); 
                gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.15);
            } catch (e) { console.error("Audio failed", e); }
        };

        const BingoGame = () => {
            // State
            const [gridSize, setGridSize] = useState(5);
            const [gameState, setGameState] = useState('setup'); 
            const [isTimeLimitMode, setIsTimeLimitMode] = useState(false);
            const [timeLimitSetting, setTimeLimitSetting] = useState(300);
            const [isPaused, setIsPaused] = useState(false); 
            const [enableSound, setEnableSound] = useState(true);
            const [soundThreshold, setSoundThreshold] = useState(30); 
            const [keepScreenOn, setKeepScreenOn] = useState(false);
            const [deletingListId, setDeletingListId] = useState(null); // V20: æ–°å¢åˆªé™¤ç¢ºèªç‹€æ…‹

            const [board, setBoard] = useState([]);
            const [markedIndices, setMarkedIndices] = useState(new Set());
            const [winLines, setWinLines] = useState([]);
            const [taskHistory, setTaskHistory] = useState({ completed: [], failed: [] });
            const [timeLeft, setTimeLeft] = useState(300);
            const [isTaskMode, setIsTaskMode] = useState(false);
            const [taskLists, setTaskLists] = useState(DEFAULT_LISTS);
            const [activeListId, setActiveListId] = useState('default-exercise');
            const [view, setView] = useState('main'); 
            const [editingList, setEditingList] = useState(null);
            const [newTaskInput, setNewTaskInput] = useState("");
            const [editingTaskIndex, setEditingTaskIndex] = useState(null); 
            const [editingTaskText, setEditingTaskText] = useState(""); 
            const [showResult, setShowResult] = useState(false); 
            const [activeTask, setActiveTask] = useState(null); 
            const [pendingMarkIndex, setPendingMarkIndex] = useState(null);
            const [draggingIndex, setDraggingIndex] = useState(null); 
            
            // Refs
            const timerRef = useRef(null);
            const gameStartTimeRef = useRef(0);
            const totalPausedTimeRef = useRef(0);
            const pauseStartRef = useRef(0);
            const dragItemRef = useRef(null); 
            const itemsRef = useRef([]); 
            const wakeLockRef = useRef(null); // Wake Lock

            // State Refs (è§£æ±º Timer é–‰åŒ…å•é¡Œ)
            const activeTaskRef = useRef(activeTask);
            const markedIndicesRef = useRef(markedIndices);
            const isTaskModeRef = useRef(isTaskMode);
            const taskListsRef = useRef(taskLists);
            const activeListIdRef = useRef(activeListId);
            const timeLimitSettingRef = useRef(timeLimitSetting);
            const isTimeLimitModeRef = useRef(isTimeLimitMode);

            // Sync Refs
            useEffect(() => { activeTaskRef.current = activeTask; }, [activeTask]);
            useEffect(() => { markedIndicesRef.current = markedIndices; }, [markedIndices]);
            useEffect(() => { isTaskModeRef.current = isTaskMode; }, [isTaskMode]);
            useEffect(() => { taskListsRef.current = taskLists; }, [taskLists]);
            useEffect(() => { activeListIdRef.current = activeListId; }, [activeListId]);
            useEffect(() => { timeLimitSettingRef.current = timeLimitSetting; }, [timeLimitSetting]);
            useEffect(() => { isTimeLimitModeRef.current = isTimeLimitMode; }, [isTimeLimitMode]);

            // Initialization
            useEffect(() => {
                const saved = localStorage.getItem('bingoTaskData');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.taskLists) {
                            setTaskLists(parsed.taskLists);
                            setActiveListId(parsed.activeListId || parsed.taskLists[0]?.id);
                        }
                    } catch(e) {}
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('bingoTaskData', JSON.stringify({ taskLists, activeListId }));
            }, [taskLists, activeListId]);

            // Wake Lock Effect
            useEffect(() => {
                const requestWakeLock = async () => {
                    if (keepScreenOn && gameState === 'playing' && 'wakeLock' in navigator) {
                        try {
                            if (!wakeLockRef.current) {
                                wakeLockRef.current = await navigator.wakeLock.request('screen');
                            }
                        } catch (err) {
                            console.log('Wake Lock Error:', err);
                        }
                    } else if ((!keepScreenOn || gameState !== 'playing') && wakeLockRef.current) {
                        try {
                            await wakeLockRef.current.release();
                            wakeLockRef.current = null;
                        } catch (err) {
                            console.log('Wake Lock Release Error:', err);
                        }
                    }
                };
                
                requestWakeLock();

                const handleVisibilityChange = async () => {
                    if (document.visibilityState === 'visible' && keepScreenOn && gameState === 'playing') {
                        // Re-acquire lock when app comes back to foreground
                        try {
                            if (!wakeLockRef.current) {
                                wakeLockRef.current = await navigator.wakeLock.request('screen');
                            }
                        } catch (err) {}
                    }
                };

                document.addEventListener('visibilitychange', handleVisibilityChange);
                return () => {
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                    if (wakeLockRef.current) wakeLockRef.current.release().catch(()=>{});
                };
            }, [keepScreenOn, gameState]);

            useEffect(() => {
                if (isPaused) {
                    pauseStartRef.current = Date.now();
                } else if (pauseStartRef.current > 0) {
                    totalPausedTimeRef.current += (Date.now() - pauseStartRef.current);
                    pauseStartRef.current = 0;
                }
            }, [isPaused]);

            // === æ ¸å¿ƒé‚è¼¯ (å®šç¾©åœ¨ Timer useEffect ä¹‹å‰) ===

            const handleSystemPick = useCallback((targetIndex) => {
                if(isTaskModeRef.current) {
                    const list = taskListsRef.current.find(l => l.id === activeListIdRef.current);
                    const tasks = list ? list.tasks : [];
                    if(tasks.length > 0) {
                        const t = tasks[Math.floor(Math.random() * tasks.length)];
                        setActiveTask(t);
                        setPendingMarkIndex(targetIndex);
                    } else {
                        setMarkedIndices(prev => new Set(prev).add(targetIndex));
                    }
                } else {
                    setMarkedIndices(prev => new Set(prev).add(targetIndex));
                }
            }, []);

            const triggerMarking = useCallback((index) => {
                if(isPaused) return;
                
                if(markedIndicesRef.current.has(index)) {
                    setMarkedIndices(prev => {
                        const next = new Set(prev);
                        next.delete(index);
                        return next;
                    });
                    return;
                }
                
                if(isTimeLimitModeRef.current) setTimeLeft(timeLimitSettingRef.current);
                handleSystemPick(index);
            }, [isPaused, handleSystemPick]);

            const handleAutoPickOnTimeout = useCallback(() => {
                const currentTask = activeTaskRef.current;
                
                if (currentTask) {
                    setTaskHistory(prev => ({ ...prev, failed: [...prev.failed, currentTask + ' (è¶…æ™‚)'] }));
                }
                setActiveTask(null);
                setPendingMarkIndex(null);
                
                const total = gridSize * gridSize;
                const currentMarked = markedIndicesRef.current;
                const unMarked = [];
                for(let i=0; i<total; i++) {
                    if(!currentMarked.has(i)) unMarked.push(i);
                }
                
                if(unMarked.length > 0) {
                    const target = unMarked[Math.floor(Math.random() * unMarked.length)];
                    handleSystemPick(target);
                }
            }, [gridSize, handleSystemPick]);

            // Timer Effect
            useEffect(() => {
                if (gameState !== 'playing' || !isTimeLimitMode || winLines.length >= 5 || isPaused) {
                    clearInterval(timerRef.current);
                    return;
                }
                timerRef.current = setInterval(() => {
                    setTimeLeft(prev => {
                        if (enableSound && prev === soundThreshold && prev > 1) {
                            playAlertSound();
                        }
                        if (prev <= 1) {
                            handleAutoPickOnTimeout();
                            return timeLimitSettingRef.current;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timerRef.current);
            }, [gameState, isTimeLimitMode, winLines, isPaused, enableSound, soundThreshold, handleAutoPickOnTimeout]);

            const initializeGame = () => {
                if (!audioCtx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) audioCtx = new AudioContext();
                }
                if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

                const total = gridSize * gridSize;
                const nums = Array.from({length: total}, (_, i) => i+1);
                for(let i=nums.length-1; i>0; i--) {
                    const j = Math.floor(Math.random()*(i+1));
                    [nums[i], nums[j]] = [nums[j], nums[i]];
                }
                setBoard(nums);
                setMarkedIndices(new Set());
                setWinLines([]);
                setTaskHistory({completed:[], failed:[]});
                setGameState('playing');
                setActiveTask(null);
                setPendingMarkIndex(null);
                setIsPaused(false);
                setTimeLeft(timeLimitSetting);
                setShowResult(false);
                gameStartTimeRef.current = Date.now();
                totalPausedTimeRef.current = 0;
                pauseStartRef.current = 0;
            };

            // Check Win
            useEffect(() => {
                if(gameState!=='playing') return;
                const lines = [];
                const check = (arr) => { if(arr.every(i => markedIndices.has(i))) lines.push(arr); };
                for(let i=0; i<gridSize; i++) {
                    const row = []; for(let j=0; j<gridSize; j++) row.push(i*gridSize+j);
                    check(row);
                }
                for(let i=0; i<gridSize; i++) {
                    const col = []; for(let j=0; j<gridSize; j++) col.push(j*gridSize+i);
                    check(col);
                }
                const d1=[], d2=[];
                for(let i=0; i<gridSize; i++) {
                    d1.push(i*gridSize+i);
                    d2.push(i*gridSize+(gridSize-1-i));
                }
                check(d1); check(d2);
                setWinLines(lines);
            }, [markedIndices, gridSize, gameState]);

            const handleTaskComplete = () => {
                if(activeTask) setTaskHistory(prev => ({...prev, completed: [...prev.completed, activeTask]}));
                if(pendingMarkIndex !== null) setMarkedIndices(prev => new Set(prev).add(pendingMarkIndex));
                setActiveTask(null);
                setPendingMarkIndex(null);
            };

            const handleTaskAbandon = () => {
                if(activeTask) setTaskHistory(prev => ({...prev, failed: [...prev.failed, activeTask + ' (æ”¾æ£„)']}));
                setActiveTask(null);
                setPendingMarkIndex(null);
            };

            const handleRandomPick = () => {
                if(isPaused) return;
                const total = gridSize*gridSize;
                const unMarked = [];
                for(let i=0; i<total; i++) if(!markedIndices.has(i)) unMarked.push(i);
                if(unMarked.length===0) return;
                const idx = unMarked[Math.floor(Math.random()*unMarked.length)];
                triggerMarking(idx);
            };

            // --- List & Drag Logic ---
            const startEditing = (list) => {
                setEditingList({...list, tasks: list.tasks.map((t, i) => ({id: `task-${Date.now()}-${i}`, text: t}))});
                setView('edit-list');
                setEditingTaskIndex(null);
                dragItemRef.current = null;
                setDraggingIndex(null);
            };

            const saveEditingList = () => {
                const clean = {...editingList, tasks: editingList.tasks.map(t => t.text)};
                setTaskLists(prev => prev.map(l => l.id === clean.id ? clean : l));
                setView('manage-lists');
                setEditingList(null);
            };

            const createNewList = () => {
                const n={id:'c-'+Date.now(), name:'æ–°åˆ—è¡¨', tasks:[]};
                setTaskLists([...taskLists, n]);
                setEditingList({...n, tasks:[]});
                setView('edit-list');
            };

            // V20: æ–°çš„åˆªé™¤é‚è¼¯
            const confirmDeleteList = () => {
                if (!deletingListId) return;
                
                const idToDelete = deletingListId;
                const newLists = taskLists.filter(x => x.id !== idToDelete);
                setTaskLists(newLists);

                // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰é¸ä¸­çš„åˆ—è¡¨ï¼Œåˆ‡æ›åˆ°ç¬¬ä¸€å€‹å¯ç”¨çš„åˆ—è¡¨
                if (activeListId === idToDelete) {
                    if (newLists.length > 0) {
                        setActiveListId(newLists[0].id);
                    } else {
                        setActiveListId(''); 
                    }
                }
                
                setDeletingListId(null);
            };

            const handleGlobalMove = (e) => {
                if (dragItemRef.current === null) return;
                const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : null);
                if (!clientY) return;

                const currentDragIndex = dragItemRef.current;
                let targetIndex = -1;
                
                for (let i = 0; i < itemsRef.current.length; i++) {
                    const node = itemsRef.current[i];
                    if (!node) continue;
                    const rect = node.getBoundingClientRect();
                    if (clientY >= rect.top - 5 && clientY <= rect.bottom + 5) {
                        targetIndex = i;
                        break;
                    }
                }

                if (targetIndex !== -1 && targetIndex !== currentDragIndex) {
                    setEditingList(prev => {
                        const newTasks = [...prev.tasks];
                        const [movedItem] = newTasks.splice(currentDragIndex, 1);
                        newTasks.splice(targetIndex, 0, movedItem);
                        return { ...prev, tasks: newTasks };
                    });
                    dragItemRef.current = targetIndex;
                    setDraggingIndex(targetIndex);
                }
            };

            const handleGlobalUp = () => {
                dragItemRef.current = null;
                setDraggingIndex(null);
                window.removeEventListener('mousemove', handleGlobalMove);
                window.removeEventListener('mouseup', handleGlobalUp);
                window.removeEventListener('touchmove', handleGlobalMove);
                window.removeEventListener('touchend', handleGlobalUp);
                document.body.style.userSelect = '';
            };

            const handleDragStart = (e, index) => {
                if (e.button === 2) return; 
                if (e.type === 'mousedown') e.preventDefault(); 
                dragItemRef.current = index;
                setDraggingIndex(index);
                document.body.style.userSelect = 'none';
                window.addEventListener('mousemove', handleGlobalMove);
                window.addEventListener('mouseup', handleGlobalUp);
                window.addEventListener('touchmove', handleGlobalMove, { passive: false });
                window.addEventListener('touchend', handleGlobalUp);
            };

            const addTaskToEditing = () => {
                if(newTaskInput.trim()){
                    setEditingList({...editingList, tasks:[...editingList.tasks, {id:Date.now(), text:newTaskInput.trim()}]});
                    setNewTaskInput('');
                }
            };

            const removeTaskFromEditing = (idx) => {
                setEditingList({...editingList, tasks: editingList.tasks.filter((_, i) => i !== idx)});
            };

            const saveTaskEdit = (idx) => {
                if(!editingTaskText.trim()) return;
                const newTasks = [...editingList.tasks];
                newTasks[idx].text = editingTaskText.trim();
                setEditingList({...editingList, tasks: newTasks});
                setEditingTaskIndex(null);
            };

            const formatTime = (s) => {
                if (isNaN(s)) return "0:00";
                const m = Math.floor(s/60);
                const secs = Math.floor(s%60);
                return `${m}:${secs<10?'0':''}${secs}`;
            };
            
            const getTotalGameTime = () => {
                const now = Date.now();
                let p = totalPausedTimeRef.current + (isPaused && pauseStartRef.current ? now - pauseStartRef.current : 0);
                return Math.max(0, Math.floor((now - gameStartTimeRef.current - p)/1000));
            };

            const handleExport = () => {
                const txt = `è³“æœæˆæœ\næ—¥æœŸ:${new Date().toLocaleString()}\næ™‚é–“:${formatTime(getTotalGameTime())}\né€£ç·š:${winLines.length}\n\nå·²å®Œæˆ:\n${taskHistory.completed.join('\n')}\n\næœªå®Œæˆ:\n${taskHistory.failed.join('\n')}`;
                const blob = new Blob([txt], {type:'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href=url; a.download='bingo.txt'; a.click();
            };

            const isCellInWinLine = (index) => winLines.some(line => line.includes(index));

            // Helper to update time
            const adjustTime = (delta) => {
                const newTime = Math.max(3, timeLimitSetting + delta);
                setTimeLimitSetting(newTime);
            };

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 flex flex-col items-center py-8 px-4 font-sans relative">
                    <header className="mb-8 text-center">
                        <h1 className="text-4xl font-bold text-slate-900 mb-2 flex justify-center items-center gap-3"><Grid3X3 className="w-8 h-8 text-indigo-600"/>æ•¸å­—è³“æœ</h1>
                        <p className="text-slate-500">è‡ªå®šç¾©å¤§å° {isTaskMode && '+ è¶£å‘³ä»»å‹™'} {isTimeLimitMode && '+ é™æ™‚æŒ‘æˆ°'}</p>
                    </header>

                    {showResult && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md lg:max-w-4xl p-6 flex flex-col max-h-[85vh]">
                                <div className="flex justify-between items-center mb-4"><h3 className="text-xl font-bold">æˆæœçµ±è¨ˆ</h3><div className="flex gap-2"><button onClick={handleExport} className="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-bold"><Download className="w-4 h-4 inline"/> åŒ¯å‡º</button><button onClick={()=>setShowResult(false)} className="p-1 bg-slate-100 rounded-full"><X/></button></div></div>
                                <div className="grid grid-cols-2 gap-4 mb-4 text-center"><div className="bg-indigo-50 p-4 rounded-xl"><div>é€£ç·šæ•¸</div><div className="text-3xl font-bold text-indigo-600">{winLines.length}</div></div><div className="bg-slate-100 p-4 rounded-xl"><div>ç¸½æ™‚é–“</div><div className="text-3xl font-bold">{formatTime(getTotalGameTime())}</div></div></div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-4">
                                    <div><h4 className="font-bold text-green-600">å·²å®Œæˆ ({taskHistory.completed.length})</h4><ul className="text-sm pl-4 grid grid-cols-1 sm:grid-cols-2 gap-2">{taskHistory.completed.map((t,i)=><li key={i} className="border-b py-1">{i+1}. {t}</li>)}</ul></div>
                                    <div><h4 className="font-bold text-red-500">æœªå®Œæˆ ({taskHistory.failed.length})</h4><ul className="text-sm pl-4 grid grid-cols-1 sm:grid-cols-2 gap-2">{taskHistory.failed.map((t,i)=><li key={i} className="border-b py-1">{i+1}. {t}</li>)}</ul></div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* V20: åˆªé™¤ç¢ºèªè¦–çª— */}
                    {deletingListId && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full animate-in zoom-in-95 duration-200">
                                <h3 className="text-lg font-bold mb-2 text-slate-900">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
                                <p className="text-slate-500 mb-6">åˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸæ­¤åˆ—è¡¨ã€‚</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeletingListId(null)} className="flex-1 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-bold transition-colors">å–æ¶ˆ</button>
                                    <button onClick={confirmDeleteList} className="flex-1 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold transition-colors">åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTask && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center relative overflow-hidden">
                                {isTimeLimitMode && !isPaused && (
                                    <div className="absolute top-0 left-0 h-2 bg-red-500 transition-all ease-linear duration-1000" style={{width: `${(timeLeft/timeLimitSetting)*100}%`}} />
                                )}
                                <div className="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4"><Dumbbell className="w-8 h-8 text-yellow-600"/></div>
                                <h3 className="text-xl font-bold mb-2">ä»»å‹™æŒ‘æˆ°ï¼</h3>
                                
                                {isTimeLimitMode && (
                                    <div className={`font-bold text-lg mb-4 flex items-center justify-center gap-2 ${isPaused ? 'text-slate-400' : 'text-red-500 animate-pulse'}`}>
                                        <Timer className="w-5 h-5" /> 
                                        {isPaused ? 'æš«åœä¸­' : `å‰©é¤˜ ${formatTime(timeLeft)}`}
                                    </div>
                                )}

                                <p className="text-2xl font-bold text-indigo-600 bg-slate-50 p-4 rounded-xl mb-6">{activeTask}</p>
                                <div className="flex gap-3">
                                    <button onClick={handleTaskAbandon} className="flex-1 py-3 rounded-xl bg-slate-100 font-bold text-slate-600" disabled={isPaused}>æ”¾æ£„</button>
                                    <button onClick={handleTaskComplete} className="flex-1 py-3 rounded-xl bg-indigo-600 font-bold text-white" disabled={isPaused}>å®Œæˆï¼</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {gameState === 'setup' && view === 'main' && (
                        <div className="w-full max-w-md bg-white p-6 rounded-2xl shadow-xl border border-slate-100 space-y-6">
                            <h2 className="text-xl font-bold flex gap-2"><Settings/> éŠæˆ²è¨­å®š</h2>
                            <div><label className="block mb-2 font-bold">ç›¤é¢: {gridSize}x{gridSize}</label><input type="range" min="3" max="10" value={gridSize} onChange={e=>setGridSize(parseInt(e.target.value))} className="w-full"/></div>
                            
                            {/* V19 æ–°å¢: ç¨ç«‹çš„è¢å¹•æ†äº®è¨­å®šå€å¡Š */}
                            <div className="bg-slate-50 p-4 rounded-xl flex justify-between items-center border border-slate-100">
                                <div className="flex gap-3 items-center">
                                    <div className={`p-2 rounded-lg transition-colors ${keepScreenOn ? 'bg-yellow-100 text-yellow-600' : 'bg-slate-200 text-slate-500'}`}><Sun className="w-5 h-5"/></div>
                                    <div className="text-left">
                                        <div className="font-bold text-slate-800">è¢å¹•æ†äº®</div>
                                        <div className="text-xs text-slate-500">éŠæˆ²ä¸­ä¿æŒè¢å¹•é–‹å•Ÿ</div>
                                    </div>
                                </div>
                                <button onClick={()=>setKeepScreenOn(!keepScreenOn)} className={`w-12 h-7 rounded-full relative transition ${keepScreenOn?'bg-yellow-400':'bg-slate-300'}`}>
                                    <div className={`w-5 h-5 bg-white rounded-full absolute top-1 transition-all shadow-sm ${keepScreenOn?'left-6':'left-1'}`}/>
                                </button>
                            </div>

                            {/* é™æ™‚æ¨¡å¼è¨­å®šå€å¡Š */}
                            <div className="bg-orange-50 p-4 rounded-xl">
                                <div className="flex justify-between items-center">
                                    <div className="flex gap-3 items-center">
                                        <div className="p-2 rounded-lg bg-orange-200 text-orange-700"><Timer className="w-5 h-5"/></div>
                                        <div className="text-left">
                                            <div className="font-bold text-slate-800">é™æ™‚æ¨¡å¼</div>
                                            <div className="text-xs text-slate-500">æ™‚é–“åˆ°è‡ªå‹•éš¨æ©Ÿé¸è™Ÿ</div>
                                        </div>
                                    </div>
                                    <button onClick={()=>setIsTimeLimitMode(!isTimeLimitMode)} className={`w-12 h-7 rounded-full relative transition ${isTimeLimitMode?'bg-orange-500':'bg-slate-300'}`}><div className={`w-5 h-5 bg-white rounded-full absolute top-1 transition-all ${isTimeLimitMode?'left-6':'left-1'}`}/></button>
                                </div>
                                {isTimeLimitMode && (
                                    <div className="mt-4 space-y-4 animate-in slide-in-from-top-2 bg-white/50 p-3 rounded-lg border border-orange-100">
                                        {/* æ™‚é–“èª¿æ•´ï¼šæŒ‰éˆ• + æ‰‹å‹•è¼¸å…¥ */}
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-2 uppercase">æ¯å›åˆå€’æ•¸æ™‚é–“</label>
                                            <div className="flex gap-2 items-center">
                                                {/* åˆ†é˜ */}
                                                <div className="flex-1 flex items-center bg-slate-100 rounded-lg p-1">
                                                    <button onClick={() => adjustTime(-60)} className="p-2 text-slate-500 hover:bg-slate-200 rounded-md"><Minus className="w-4 h-4"/></button>
                                                    <div className="flex-1 flex items-center justify-center relative">
                                                        <input 
                                                            type="number" 
                                                            min="0"
                                                            className="w-16 text-center font-bold text-lg bg-transparent outline-none p-0 appearance-none"
                                                            value={Math.floor(timeLimitSetting/60)}
                                                            onChange={(e) => {
                                                                const val = parseInt(e.target.value) || 0;
                                                                const secs = timeLimitSetting % 60;
                                                                setTimeLimitSetting(Math.max(3, val * 60 + secs));
                                                            }}
                                                            onFocus={(e) => e.target.select()}
                                                        />
                                                        <span className="text-xs font-normal text-slate-400 ml-1">åˆ†</span>
                                                    </div>
                                                    <button onClick={() => adjustTime(60)} className="p-2 text-slate-500 hover:bg-slate-200 rounded-md"><Plus className="w-4 h-4"/></button>
                                                </div>
                                                <span className="text-slate-400 font-bold">:</span>
                                                {/* ç§’é˜ */}
                                                <div className="flex-1 flex items-center bg-slate-100 rounded-lg p-1">
                                                    <button onClick={() => adjustTime(-5)} className="p-2 text-slate-500 hover:bg-slate-200 rounded-md"><Minus className="w-4 h-4"/></button>
                                                    <div className="flex-1 flex items-center justify-center relative">
                                                        <input 
                                                            type="number" 
                                                            min="0"
                                                            className="w-16 text-center font-bold text-lg bg-transparent outline-none p-0 appearance-none"
                                                            value={timeLimitSetting % 60}
                                                            onChange={(e) => {
                                                                const val = parseInt(e.target.value) || 0;
                                                                const mins = Math.floor(timeLimitSetting/60);
                                                                setTimeLimitSetting(Math.max(3, mins * 60 + val));
                                                            }}
                                                            onFocus={(e) => e.target.select()}
                                                        />
                                                        <span className="text-xs font-normal text-slate-400 ml-1">ç§’</span>
                                                    </div>
                                                    <button onClick={() => adjustTime(5)} className="p-2 text-slate-500 hover:bg-slate-200 rounded-md"><Plus className="w-4 h-4"/></button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* éŸ³æ•ˆè¨­å®š (V19: ç§»é™¤è¢å¹•æ†äº®ï¼Œä¿ç•™éŸ³æ•ˆ) */}
                                        <div className="flex items-center justify-between border-t border-slate-100 pt-3">
                                            <div className="flex items-center gap-2">
                                                <button onClick={()=>setEnableSound(!enableSound)} className={`p-1.5 rounded-lg transition-colors ${enableSound?'bg-orange-100 text-orange-600':'bg-slate-100 text-slate-400'}`}>{enableSound?<Volume2 className="w-4 h-4"/>:<VolumeX className="w-4 h-4"/>}</button>
                                                {/* å¯èª¿æ•´æç¤ºéŸ³ç§’æ•¸çš„ä»‹é¢ */}
                                                <div className="flex items-center bg-slate-100 rounded-lg">
                                                    <button onClick={() => setSoundThreshold(p => Math.max(5, p - 5))} disabled={!enableSound} className="px-2 py-1 text-slate-500 hover:text-indigo-600 disabled:opacity-50 text-xs font-bold">-</button>
                                                    <span className={`text-xs font-bold w-12 text-center ${enableSound ? 'text-slate-600' : 'text-slate-400'}`}>å‰© {soundThreshold} ç§’</span>
                                                    <button onClick={() => setSoundThreshold(p => p + 5)} disabled={!enableSound} className="px-2 py-1 text-slate-500 hover:text-indigo-600 disabled:opacity-50 text-xs font-bold">+</button>
                                                </div>
                                            </div>
                                        </div>
                                        <p className="text-xs text-slate-400">* é»æ“Šæ ¼å­å¾Œé‡ç½®æ™‚é–“ï¼Œéœ€åœ¨æ™‚é–“å…§å®Œæˆä»»å‹™ä¸¦é¸å–ä¸‹ä¸€æ ¼</p>
                                    </div>
                                )}
                            </div>

                            {/* ä»»å‹™æ¨¡å¼è¨­å®šå€å¡Š */}
                            <div className="bg-indigo-50 p-4 rounded-xl">
                                <div className="flex justify-between items-center">
                                    <div className="flex gap-3 items-center">
                                        <div className="p-2 rounded-lg bg-indigo-200 text-indigo-700"><Dumbbell className="w-5 h-5"/></div>
                                        <div className="text-left">
                                            <div className="font-bold text-slate-800">ä»»å‹™æ¨¡å¼</div>
                                            <div className="text-xs text-slate-500">é¸è™Ÿæ™‚è·³å‡ºæŒ‘æˆ°</div>
                                        </div>
                                    </div>
                                    <button onClick={()=>setIsTaskMode(!isTaskMode)} className={`w-12 h-7 rounded-full relative transition ${isTaskMode?'bg-indigo-600':'bg-slate-300'}`}><div className={`w-5 h-5 bg-white rounded-full absolute top-1 transition-all ${isTaskMode?'left-6':'left-1'}`}/></button>
                                </div>
                                {isTaskMode && <div className="mt-4 flex gap-2"><select value={activeListId} onChange={e=>setActiveListId(e.target.value)} className="flex-1 p-2 border rounded"><option disabled value="">é¸æ“‡åˆ—è¡¨</option>{taskLists.map(l=><option key={l.id} value={l.id}>{l.name}</option>)}</select><button onClick={()=>setView('manage-lists')} className="p-2 bg-slate-200 rounded"><LayoutList/></button></div>}
                            </div>
                            <div className="flex gap-2"><button onClick={initializeGame} className="flex-[2] py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">é–‹å§‹éŠæˆ²</button><a href="../../index.html" className="flex-1 py-3 flex justify-center items-center bg-slate-100 font-bold rounded-xl text-slate-600">å›é¦–é </a></div>
                        </div>
                    )}

                    {gameState === 'setup' && view === 'manage-lists' && (
                        <div className="w-full max-w-md bg-white p-6 rounded-2xl shadow-xl h-[500px] flex flex-col">
                            <div className="flex items-center gap-2 mb-4"><button onClick={()=>setView('main')} className="p-1 hover:bg-slate-100 rounded"><ChevronLeft/></button><h2 className="text-xl font-bold">ç®¡ç†åˆ—è¡¨</h2></div>
                            <div className="flex-1 overflow-y-auto space-y-2">{taskLists.map(l=><div key={l.id} className="p-3 border rounded-lg flex justify-between items-center"><div className="flex items-center gap-3 overflow-hidden"><FolderOpen className={`w-5 h-5 ${l.id===activeListId?'text-indigo-600':'text-slate-400'}`}/><div><div className="font-bold text-slate-800 truncate">{l.name}</div><div className="text-xs text-slate-500">{l.tasks.length} å€‹ä»»å‹™</div></div></div><div className="flex gap-1"><button onClick={()=>startEditing(l)} className="p-2 border rounded hover:bg-slate-50 text-indigo-600"><Edit2 className="w-4 h-4"/></button>{taskLists.length>1&&<button onClick={()=>setDeletingListId(l.id)} className="p-2 border rounded hover:bg-red-50 text-red-500"><Trash2 className="w-4 h-4"/></button>}</div></div>)}</div>
                            <button onClick={createNewList} className="mt-4 w-full py-2 bg-slate-100 rounded-lg font-bold flex justify-center items-center gap-2"><Plus/> æ–°å¢åˆ—è¡¨</button>
                        </div>
                    )}

                    {gameState === 'setup' && view === 'edit-list' && editingList && (
                        <div className="w-full max-w-md bg-white p-6 rounded-2xl shadow-xl h-[600px] flex flex-col">
                            <div className="flex items-center gap-2 mb-4"><button onClick={saveEditingList} className="p-1 hover:bg-slate-100 rounded"><ChevronLeft/></button><h2 className="text-xl font-bold">ç·¨è¼¯åˆ—è¡¨</h2><button onClick={saveEditingList} className="ml-auto flex items-center gap-1 px-3 py-1 bg-indigo-600 text-white rounded text-sm font-bold"><Save className="w-4 h-4"/> å„²å­˜</button></div>
                            <div className="mb-4 space-y-2">
                                <input className="w-full p-2 border rounded" value={editingList.name} onChange={e=>setEditingList({...editingList, name:e.target.value})} placeholder="åˆ—è¡¨åç¨±"/>
                                <div className="flex gap-2"><input className="flex-1 p-2 border rounded" value={newTaskInput} onChange={e=>setNewTaskInput(e.target.value)} placeholder="æ–°ä»»å‹™..." onKeyDown={e=>e.key==='Enter'&&addTaskToEditing()}/><button onClick={addTaskToEditing} className="p-2 bg-indigo-100 text-indigo-600 rounded"><Plus/></button></div>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-1 pb-4 relative sortable-list">
                                {editingList.tasks.map((task, idx) => (
                                    <div 
                                        key={task.id} 
                                        ref={el => itemsRef.current[idx] = el}
                                        className={`task-row flex items-center gap-2 p-3 bg-slate-50 rounded-lg transition-transform ${draggingIndex === idx ? 'is-dragging' : ''}`}
                                    >
                                        <div 
                                            className="drag-handle text-slate-400 hover:text-indigo-600 p-2"
                                            onMouseDown={(e) => handleDragStart(e, idx)}
                                            onTouchStart={(e) => handleDragStart(e, idx)}
                                        >
                                            <GripVertical className="w-5 h-5 pointer-events-none" />
                                        </div>
                                        {editingTaskIndex === idx ? (
                                            <div className="flex-1 flex gap-2"><input autoFocus className="flex-1 px-2 border rounded" value={editingTaskText} onChange={e=>setEditingTaskText(e.target.value)} onKeyDown={e=>e.key==='Enter'&&saveTaskEdit(idx)} /><button onClick={()=>saveTaskEdit(idx)} className="text-green-600"><Check/></button></div>
                                        ) : (
                                            <span className="flex-1 truncate select-none">{task.text}</span>
                                        )}
                                        {editingTaskIndex !== idx && <div className="flex gap-1"><button onClick={()=>{setEditingTaskIndex(idx); setEditingTaskText(task.text)}} className="text-slate-300 hover:text-indigo-600"><Edit2 className="w-4 h-4"/></button><button onClick={()=>removeTaskFromEditing(idx)} className="text-slate-300 hover:text-red-500"><Trash2 className="w-4 h-4"/></button></div>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {gameState === 'playing' && (
                        <div className="w-full max-w-2xl flex flex-col items-center animate-in fade-in">
                            <div className="w-full flex flex-col sm:flex-row justify-between items-center mb-6 bg-white p-3 rounded-xl shadow-sm gap-3 sm:gap-0">
                                <div className="flex gap-4 items-center w-full sm:w-auto justify-between sm:justify-start">
                                    <div className="flex items-center gap-2 sm:gap-3">
                                        <div className={`p-2 rounded-lg shrink-0 ${winLines.length > 0 ? 'bg-yellow-100 text-yellow-600' : 'bg-slate-100 text-slate-500'}`}><Trophy className="w-5 h-5" /></div>
                                        <div><div className="text-xs text-slate-500 font-medium hidden md:block">é€£ç·šæ•¸</div><div className="text-xl sm:text-2xl font-bold text-slate-800 tabular-nums">{winLines.length}<span className="text-sm font-normal text-slate-400 ml-1 md:hidden">æ¢</span><span className="text-sm font-normal text-slate-400 ml-1 hidden md:inline">æ¢</span></div></div>
                                    </div>
                                    {isTimeLimitMode && (
                                        <div className="flex items-center gap-2 sm:gap-3 pl-3 sm:pl-4 border-l border-slate-200">
                                        <div className={`p-2 rounded-lg shrink-0 transition-colors ${isPaused ? 'bg-slate-100 text-slate-500' : timeLeft < 10 ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-orange-100 text-orange-600'}`}><Timer className="w-5 h-5" /></div>
                                        <div><div className="text-xs text-slate-500 font-medium hidden md:block">å‰©é¤˜</div><div className={`text-xl sm:text-2xl font-bold tabular-nums ${timeLeft < 10 && !isPaused ? 'text-red-600' : 'text-slate-800'}`}>{formatTime(timeLeft)}</div></div>
                                        <button onClick={()=>setIsPaused(!isPaused)} className={`ml-1 p-1.5 rounded-full transition-all active:scale-95 border ${isPaused ? 'bg-green-100 text-green-600 border-green-200 hover:bg-green-200' : 'bg-slate-50 text-slate-500 border-slate-200 hover:bg-slate-100'}`} title={isPaused ? "ç¹¼çºŒ" : "æš«åœ"}>{isPaused ? <Play className="w-4 h-4 fill-current" /> : <Pause className="w-4 h-4 fill-current" />}</button>
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-2 w-full sm:w-auto justify-end">
                                    <button onClick={handleRandomPick} disabled={markedIndices.size === gridSize * gridSize || activeTask !== null || isPaused} className="flex items-center gap-2 px-3 py-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="éš¨æ©Ÿé¸è™Ÿ"><Dices className="w-4 h-4" /><span className="hidden md:inline">éš¨æ©Ÿ</span></button>
                                    <div className="w-px h-8 bg-slate-200 mx-0.5 hidden sm:block"></div>
                                    <button onClick={()=>setShowResult(true)} className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition-colors" title="æŸ¥çœ‹æˆæœ"><ClipboardList className="w-4 h-4" /><span className="hidden lg:inline">æˆæœ</span></button>
                                    <button onClick={initializeGame} className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition-colors" title="é‡ç½®"><RotateCcw className="w-4 h-4" /> <span className="hidden lg:inline">é‡ç½®</span></button>
                                    <button onClick={()=>setGameState('setup')} className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition-colors" title="è¨­å®š"><Settings className="w-4 h-4" /> <span className="hidden lg:inline">è¨­å®š</span></button>
                                </div>
                            </div>
                            {isTimeLimitMode && winLines.length < 5 && (
                                <div className="w-full h-2 bg-slate-100 rounded-full mb-4 overflow-hidden">
                                <div className={`h-full transition-all ease-linear ${isPaused ? 'bg-slate-300' : timeLeft < 10 ? 'bg-red-500 duration-1000' : 'bg-orange-500 duration-1000'}`} style={{ width: `${(timeLeft / timeLimitSetting) * 100}%` }} />
                                </div>
                            )}
                            <div className="grid gap-2 sm:gap-3 p-3 sm:p-4 bg-white rounded-2xl shadow-xl border border-slate-200 select-none relative" style={{ gridTemplateColumns: `repeat(${gridSize}, minmax(0, 1fr))`, width: '100%', maxWidth: '600px', aspectRatio: '1/1' }}>
                                {isPaused && (
                                <div className="absolute inset-0 z-20 bg-slate-100/90 backdrop-blur-sm rounded-xl flex flex-col items-center justify-center animate-in fade-in">
                                    <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 flex flex-col items-center">
                                    <Pause className="w-12 h-12 text-slate-400 mb-2" />
                                    <span className="text-xl font-bold text-slate-600">éŠæˆ²æš«åœ</span>
                                    <button onClick={() => setIsPaused(false)} className="mt-4 px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold transition-colors flex items-center gap-2"><Play className="w-4 h-4 fill-current" /> ç¹¼çºŒéŠæˆ²</button>
                                    </div>
                                </div>
                                )}
                                {board && board.length > 0 && board.map((num, index) => {
                                const isMarked = markedIndices.has(index);
                                const isWin = isCellInWinLine(index);
                                return (
                                    <div key={index} onClick={() => triggerMarking(index)} className={`relative flex items-center justify-center rounded-lg sm:rounded-xl cursor-pointer transition-all duration-200 text-base sm:text-xl md:text-2xl font-bold shadow-sm ${isPaused ? 'cursor-not-allowed' : ''} ${isWin ? 'bg-yellow-400 text-white scale-105 z-10 ring-4 ring-yellow-200 shadow-yellow-200' : isMarked ? 'bg-indigo-600 text-white scale-[0.98] ring-0 opacity-90' : 'bg-slate-50 text-slate-700 hover:bg-slate-100 border border-slate-200'}`}>
                                    {num}
                                    {isMarked && !isWin && <div className="absolute inset-0 flex items-center justify-center opacity-20 pointer-events-none"><Check className="w-3/4 h-3/4 text-white" /></div>}
                                    </div>
                                );
                                })}
                            </div>
                            {winLines.length >= 5 && (
                                <div className="mt-8 px-6 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-full font-bold shadow-lg animate-bounce">å¤ªå¼·äº†ï¼è³“æœå¤§å¸«ï¼ ({winLines.length} é€£ç·š)</div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BingoGame />);
    </script>
</body>
</html>