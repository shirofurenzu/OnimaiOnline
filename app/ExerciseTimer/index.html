<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‹å‹•è¨ˆæ™‚å™¨</title>
    
    <!-- PWA ç›¸é—œè¨­å®šå°‡ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- é ç•™ favicon ä½ç½® -->
    <link id="faviconLink" rel="icon" type="image/png" href="">
    <link id="appleIconLink" rel="apple-touch-icon" href="">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&display=swap');
        
        body {
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: white;
            transition: background-color 0.5s ease;
            -webkit-user-select: none;
            user-select: none;
        }

        .timer-font {
            font-family: 'Roboto Mono', monospace;
        }

        /* å‘¼å¸å‹•ç•«æ•ˆæœ - ç”¨æ–¼å€’æ•¸ */
        @keyframes pulse-red {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .urgent {
            color: #ef4444; /* Red 500 */
            animation: pulse-red 0.5s infinite;
        }

        /* ç‹€æ…‹èƒŒæ™¯è‰²é¡åˆ¥ */
        .bg-work { background-color: #064e3b; } /* Emerald 900 */
        .bg-rest { background-color: #a16207; } /* Yellow 700 */
        .bg-prep { background-color: #1e3a8a; } /* Blue 900 */
        .bg-idle { background-color: #0f172a; } /* Slate 900 */

        /* Progress Bar Colors */
        .bar-work { background-color: #10b981; } /* Emerald 500 */
        .bar-rest { background-color: #fbbf24; } /* Amber 400 */
        .bar-prep { background-color: #3b82f6; } /* Blue 500 */
        .bar-idle { background-color: #475569; } /* Slate 600 */

        /* Modal å‹•ç•« */
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal.hidden .modal-content { transform: scale(0.95); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body id="mainBody" class="bg-idle min-h-screen flex items-center justify-center p-4">

    <!-- ä¸»å®¹å™¨ -->
    <div class="w-full max-w-md md:max-w-3xl lg:max-w-4xl bg-slate-800 rounded-3xl shadow-2xl overflow-hidden border border-slate-700 transition-all duration-300 relative flex flex-col">
        
        <!-- è¦–è¦ºåŒ–é€²åº¦æ¢ -->
        <div class="w-full h-2 bg-slate-900/50">
            <div id="progressBar" class="h-full w-full bar-idle transition-all duration-1000 ease-linear origin-left"></div>
        </div>

        <!-- Header -->
        <div class="bg-slate-900 p-4 md:p-6 relative flex justify-between items-center border-b border-slate-700">
            <!-- éœéŸ³é–‹é—œ -->
            <button id="muteBtn" class="p-2 text-slate-400 hover:text-white transition rounded-full hover:bg-slate-700" title="éœéŸ³é–‹é—œ">
                <svg id="soundOnIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-8 md:w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
                <svg id="soundOffIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-8 md:w-8 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
                </svg>
            </button>

            <h1 class="text-xl md:text-3xl font-bold text-slate-100 tracking-wide absolute left-1/2 transform -translate-x-1/2 w-full text-center pointer-events-none">é‹å‹•è¨ˆæ™‚å™¨</h1>
            
            <!-- è¨­å®šæŒ‰éˆ• -->
            <button id="settingsBtn" class="p-2 text-slate-400 hover:text-white transition rounded-full hover:bg-slate-700" title="è¨­å®š">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-8 md:w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>

        <!-- Display Area -->
        <div class="p-6 md:p-12 text-center relative flex flex-col justify-center min-h-[50vh] md:min-h-[60vh] flex-1">
            
            <!-- ä¸Šæ–¹è³‡è¨Šå€ -->
            <div class="mb-6 md:mb-10 flex flex-wrap items-center justify-center gap-4 md:gap-6 min-h-[4rem]">
                <span id="statusBadge" class="inline-block px-6 py-2 rounded-full text-base md:text-xl font-bold bg-slate-600 text-slate-200 tracking-wider uppercase shadow-md transition-all opacity-0">
                </span>
                
                <div id="exerciseNameDisplay" class="hidden text-xl md:text-3xl font-bold text-blue-200 tracking-wide opacity-0 transition-opacity duration-500">
                </div>
            </div>

            <!-- Main Timer -->
            <div class="relative z-10 my-4">
                <div id="timerDisplay" class="timer-font text-8xl md:text-9xl lg:text-[12rem] leading-none font-bold tracking-tighter text-white drop-shadow-2xl cursor-pointer hover:opacity-90 transition-opacity select-none" title="é»æ“Šæš«åœ/é–‹å§‹">
                    00:30
                </div>
            </div>

            <!-- Counters Grid -->
            <div class="mt-8 md:mt-12 grid grid-cols-2 gap-8 border-t border-slate-700/50 pt-8 max-w-2xl mx-auto w-full">
                <div class="flex flex-col items-center justify-center">
                    <span class="text-slate-400 text-sm md:text-lg font-bold uppercase tracking-wider mb-2">ç›®å‰çµ„æ•¸</span>
                    <span id="setCounter" class="text-emerald-400 text-4xl md:text-6xl font-bold timer-font">1</span>
                </div>
                
                <div class="flex flex-col items-center justify-center border-l border-slate-700/50">
                    <span class="text-slate-400 text-sm md:text-lg font-bold uppercase tracking-wider mb-2">ç¸½æ™‚é–“</span>
                    <span id="totalTimeDisplay" class="text-slate-300 text-4xl md:text-6xl font-bold timer-font">00:00</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="p-6 md:p-8 bg-slate-900 border-t border-slate-700 grid grid-cols-2 gap-6">
            <button id="startBtn" class="col-span-1 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-5 md:py-6 text-xl rounded-2xl shadow-lg transform active:scale-95 transition flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                é–‹å§‹
            </button>
            
            <button id="resetBtn" class="col-span-1 bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold py-5 md:py-6 text-xl rounded-2xl shadow-lg transform active:scale-95 transition flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                é‡ç½®
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="modal-content bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl border border-slate-600 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                <h2 class="text-2xl font-bold text-white">è¨­å®š</h2>
                <button id="closeSettingsBtn" class="text-slate-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-8 flex-1">
                <!-- Time Settings -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-2 uppercase tracking-wider">é‹å‹•æ™‚é–“ (ç§’)</label>
                        <input type="number" id="workInput" min="1" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 text-center text-xl focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2 uppercase tracking-wider">ä¼‘æ¯æ™‚é–“ (ç§’)</label>
                        <input type="number" id="restInput" min="1" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 text-center text-xl focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    </div>
                </div>

                <!-- Toggles -->
                <div class="space-y-4 bg-slate-900/50 p-4 rounded-xl">
                    <!-- Prep -->
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-lg font-bold text-white">10ç§’å‰ç½®æº–å‚™</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="prepToggle" class="sr-only peer">
                            <div class="w-14 h-7 bg-slate-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <!-- TTS -->
                    <div class="flex items-center justify-between border-t border-slate-700 pt-4">
                        <div class="flex-1">
                            <span class="text-lg font-bold text-white">èªéŸ³æ’­å ±</span>
                            <p class="text-xs text-slate-400">æœ—è®€ä¸‹ä¸€å€‹é‹å‹•é …ç›®</p>
                        </div>
                        <!-- Test Button -->
                        <button id="testVoiceBtn" class="mr-3 text-xs bg-slate-600 hover:bg-slate-500 text-white px-3 py-1.5 rounded transition">æ¸¬è©¦èªéŸ³</button>
                        
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="ttsToggle" class="sr-only peer">
                            <div class="w-14 h-7 bg-slate-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                    </div>

                    <!-- Wake Lock -->
                    <div class="flex items-center justify-between border-t border-slate-700 pt-4">
                        <div>
                            <span class="text-lg font-bold text-white">è¢å¹•æ†äº®</span>
                            <p class="text-xs text-slate-400">é˜²æ­¢æ‰‹æ©Ÿè‡ªå‹•ä¼‘çœ </p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="wakeLockToggle" class="sr-only peer">
                            <div class="w-14 h-7 bg-slate-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                </div>

                <!-- Exercise List -->
                <div>
                    <label class="block text-sm text-slate-400 mb-2 uppercase tracking-wider">è‡ªè¨‚é‹å‹•å¾ªç’°æ¸…å–® (ä¸€è¡Œä¸€å€‹)</label>
                    <textarea id="exerciseListInput" rows="4" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 text-lg leading-relaxed focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <!-- Presets -->
                <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600">
                    <h3 class="text-sm text-slate-300 uppercase tracking-wider mb-3">æ¨¡å¼ç®¡ç† (å„²å­˜/è®€å–)</h3>
                    <div class="flex gap-2 mb-3">
                        <select id="presetSelect" class="flex-1 bg-slate-800 text-white border border-slate-600 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- JS populated -->
                        </select>
                        <button id="loadPresetBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold">è®€å–</button>
                    </div>
                    <div class="flex gap-2">
                         <input type="text" id="newPresetName" placeholder="è¼¸å…¥åç¨±ä»¥å„²å­˜ç›®å‰è¨­å®š" class="flex-1 bg-slate-800 text-white border border-slate-600 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                         <button id="savePresetBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-bold">å„²å­˜</button>
                    </div>
                     <div class="mt-2 text-right">
                        <button id="deletePresetBtn" class="text-red-400 hover:text-red-300 text-xs underline">åˆªé™¤é¸å–æ¨¡å¼</button>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-700 bg-slate-900 rounded-b-2xl">
                <button id="saveSettingsBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition">
                    å„²å­˜ä¸¦è¿”å›
                </button>
            </div>
        </div>
    </div>

    <script>
        // *** è¨­å®šæ‚¨çš„åœ–ç¤º ***
        // å»ºè­°å°‡ icon.png æ”¾åœ¨èˆ‡ html æª”æ¡ˆåŒä¸€å€‹è³‡æ–™å¤¾å…§
        // å¦‚æœæª”åä¸åŒï¼Œè«‹ä¿®æ”¹ä¸‹æ–¹çš„ 'icon.png'
        const ICON_URL = 'icon.png'; 

        // --- PWA Setup Logic ---
        (function setupPWA() {
            // Update Favicon & Apple Touch Icon
            const favicon = document.getElementById('faviconLink');
            const appleIcon = document.getElementById('appleIconLink');
            
            if(favicon) favicon.href = ICON_URL;
            if(appleIcon) appleIcon.href = ICON_URL;

            // Generate Manifest Blob
            const manifest = {
                name: "é‹å‹•è¨ˆæ™‚å™¨",
                short_name: "é‹å‹•è¨ˆæ™‚å™¨",
                start_url: ".",
                display: "standalone",
                background_color: "#0f172a",
                theme_color: "#0f172a",
                icons: [
                    {
                        src: ICON_URL,
                        sizes: "192x192",
                        type: "image/png"
                    },
                    {
                        src: ICON_URL,
                        sizes: "512x512",
                        type: "image/png"
                    }
                ]
            };
            const stringManifest = JSON.stringify(manifest);
            const blob = new Blob([stringManifest], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            
            // Inject Link
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);
        })();

        // --- DOM Elements ---
        const timerDisplay = document.getElementById('timerDisplay');
        const progressBar = document.getElementById('progressBar');
        const statusBadge = document.getElementById('statusBadge');
        const setCounter = document.getElementById('setCounter');
        const totalTimeDisplay = document.getElementById('totalTimeDisplay');
        const exerciseNameDisplay = document.getElementById('exerciseNameDisplay');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const muteBtn = document.getElementById('muteBtn');
        const soundOnIcon = document.getElementById('soundOnIcon');
        const soundOffIcon = document.getElementById('soundOffIcon');
        const mainBody = document.getElementById('mainBody');
        
        // Modal & Inputs
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        
        const workInput = document.getElementById('workInput');
        const restInput = document.getElementById('restInput');
        const prepToggle = document.getElementById('prepToggle');
        const ttsToggle = document.getElementById('ttsToggle');
        const wakeLockToggle = document.getElementById('wakeLockToggle');
        const exerciseListInput = document.getElementById('exerciseListInput');
        const testVoiceBtn = document.getElementById('testVoiceBtn');
        
        const presetSelect = document.getElementById('presetSelect');
        const loadPresetBtn = document.getElementById('loadPresetBtn');
        const savePresetBtn = document.getElementById('savePresetBtn');
        const newPresetName = document.getElementById('newPresetName');
        const deletePresetBtn = document.getElementById('deletePresetBtn');

        // --- State ---
        let timer = null;
        let isRunning = false;
        let mode = 'idle'; 
        let currentTime = 30;
        let maxModeTime = 30; 
        let totalSets = 1;
        let totalSeconds = 0;
        let wakeLock = null;
        let audioCtx = null;
        let ttsTimeout = null; 
        
        // --- Defaults ---
        const DEFAULT_PRESETS = [];

        let settings = {
            workTime: 30,
            restTime: 10,
            prepEnabled: true,
            ttsEnabled: false,
            wakeLockEnabled: true,
            soundEnabled: true,
            exercises: [],
            customPresets: []
        };

        // --- Voices Management ---
        let voices = [];
        function populateVoices() {
            if ('speechSynthesis' in window) {
                voices = window.speechSynthesis.getVoices();
            }
        }
        if ('speechSynthesis' in window) {
            populateVoices();
            window.speechSynthesis.onvoiceschanged = populateVoices;
        }

        // --- Storage & Presets ---
        function loadSettings() {
            const saved = localStorage.getItem('timerSettings_v2'); 
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    settings = { ...settings, ...parsed }; 
                } catch (e) { console.error('Settings load error', e); }
            }
            applySettingsToInputs();
            updatePresetList();
            updateMuteIcon();
            
            currentTime = settings.workTime;
            maxModeTime = settings.workTime;
            timerDisplay.textContent = formatTime(currentTime);
        }

        function saveSettings() {
            settings.workTime = parseInt(workInput.value) || 30;
            settings.restTime = parseInt(restInput.value) || 10;
            settings.prepEnabled = prepToggle.checked;
            settings.ttsEnabled = ttsToggle.checked;
            settings.wakeLockEnabled = wakeLockToggle.checked;
            
            const rawList = exerciseListInput.value.trim();
            settings.exercises = rawList ? rawList.split('\n').map(s => s.trim()).filter(s => s) : [];

            localStorage.setItem('timerSettings_v2', JSON.stringify(settings));
        }

        function applySettingsToInputs() {
            workInput.value = settings.workTime;
            restInput.value = settings.restTime;
            prepToggle.checked = settings.prepEnabled;
            ttsToggle.checked = settings.ttsEnabled;
            wakeLockToggle.checked = settings.wakeLockEnabled;
            exerciseListInput.value = settings.exercises.join('\n');
        }

        function updatePresetList() {
            presetSelect.innerHTML = '';
            const allPresets = [...DEFAULT_PRESETS, ...settings.customPresets];
            allPresets.forEach((preset, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = preset.name;
                if (index >= DEFAULT_PRESETS.length) {
                    option.dataset.type = 'custom';
                    option.dataset.customIndex = index - DEFAULT_PRESETS.length;
                }
                presetSelect.appendChild(option);
            });
        }

        // --- Logic Helper ---
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function getExerciseName(setNum) {
            if (!settings.exercises || settings.exercises.length === 0) return '';
            const index = (setNum - 1) % settings.exercises.length;
            return settings.exercises[index];
        }

        // --- Audio & TTS ---
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playTone(type) {
            if (!settings.soundEnabled) return;
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'tick') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'end') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.6);
            } else if (type === 'prep') {
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            }
        }

        function getBestVoice() {
            if (voices.length === 0) return null;
            let voice = voices.find(v => v.lang === 'zh-TW' || v.lang.replace('_', '-').includes('zh-TW'));
            if (!voice) voice = voices.find(v => v.lang.includes('zh'));
            return voice;
        }

        function speak(text, callback) {
            if (!settings.soundEnabled || !settings.ttsEnabled) return;
            doSpeak(text, callback);
        }

        function doSpeak(text, callback) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                const bestVoice = getBestVoice();
                if (bestVoice) {
                    utterance.voice = bestVoice;
                }
                utterance.lang = 'zh-TW'; 
                utterance.rate = 1.0;
                utterance.volume = 1.0;
                if (callback) {
                    utterance.onend = callback;
                }
                window.speechSynthesis.speak(utterance);
            }
        }

        async function requestWakeLock() {
            if (!settings.wakeLockEnabled) return;
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.warn('WakeLock failed:', err); }
        }

        async function releaseWakeLock() {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
            }
        }
        
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible' && isRunning) {
                requestWakeLock();
            }
        });

        // --- Core Timer Logic ---
        function setMode(newMode) {
            mode = newMode;
            mainBody.className = "min-h-screen flex items-center justify-center p-4 transition-colors duration-500 ";
            progressBar.className = "h-full w-full transition-all duration-1000 ease-linear origin-left ";

            const showName = (text, colorClass) => {
                exerciseNameDisplay.textContent = text;
                exerciseNameDisplay.className = `text-xl md:text-3xl font-bold ${colorClass} tracking-wide transition-opacity duration-500`;
                exerciseNameDisplay.classList.remove('hidden');
                setTimeout(() => exerciseNameDisplay.classList.remove('opacity-0'), 10);
            };

            const hideName = () => {
                exerciseNameDisplay.classList.add('hidden');
                exerciseNameDisplay.classList.add('opacity-0');
                exerciseNameDisplay.textContent = '';
            };

            statusBadge.classList.remove('opacity-0');

            if (mode === 'prep') {
                mainBody.classList.add('bg-prep');
                progressBar.classList.add('bar-prep');
                statusBadge.textContent = "æº–å‚™";
                statusBadge.className = "inline-block px-6 py-2 rounded-full text-base md:text-xl font-bold bg-blue-600 text-white tracking-wider uppercase shadow-md transition-all";
                
                const nextName = getExerciseName(1);
                if (nextName) {
                    showName("ä¸‹ä¸€çµ„: " + nextName, "text-blue-200");
                    speak("æº–å‚™é–‹å§‹ï¼Œä¸‹ä¸€çµ„ï¼š" + nextName);
                } else {
                    hideName();
                    speak("æº–å‚™é–‹å§‹");
                }

                currentTime = 10;
                maxModeTime = 10;
            } else if (mode === 'work') {
                mainBody.classList.add('bg-work');
                progressBar.classList.add('bar-work');
                statusBadge.textContent = "ğŸ”¥ é‹å‹•ä¸­";
                statusBadge.className = "inline-block px-6 py-2 rounded-full text-base md:text-xl font-bold bg-emerald-500 text-white tracking-wider uppercase shadow-md transition-all";
                
                const name = getExerciseName(totalSets);
                if (name) {
                    showName(name, "text-blue-200");
                } else {
                    hideName();
                }
                
                speak("é–‹å§‹");
                currentTime = settings.workTime;
                maxModeTime = settings.workTime;
            } else if (mode === 'rest') {
                mainBody.classList.add('bg-rest');
                progressBar.classList.add('bar-rest');
                statusBadge.textContent = "â˜• ä¼‘æ¯";
                statusBadge.className = "inline-block px-6 py-2 rounded-full text-base md:text-xl font-bold bg-yellow-600 text-white tracking-wider uppercase shadow-md transition-all";
                
                const nextName = getExerciseName(totalSets + 1);
                if (nextName) {
                    showName("ä¸‹ä¸€çµ„: " + nextName, "text-slate-300");
                    speak("ä¼‘æ¯", () => {
                        if (!isRunning) return; 
                        ttsTimeout = setTimeout(() => {
                            speak("ä¸‹ä¸€çµ„ï¼š" + nextName);
                        }, 500); // 0.5s pause
                    });
                } else {
                    hideName();
                    speak("ä¼‘æ¯");
                }
                
                currentTime = settings.restTime;
                maxModeTime = settings.restTime;
            } else {
                mainBody.classList.add('bg-idle');
                progressBar.classList.add('bar-idle');
                statusBadge.textContent = "";
                statusBadge.classList.add('opacity-0');
                hideName();
                maxModeTime = 1; 
            }
            updateDisplay();
            updateProgressBar();
        }

        function updateDisplay() {
            timerDisplay.textContent = formatTime(currentTime);
            if (currentTime <= 3 && isRunning && currentTime > 0) {
                timerDisplay.classList.add('urgent');
            } else {
                timerDisplay.classList.remove('urgent');
            }
        }
        
        function updateProgressBar() {
            if (mode === 'idle') {
                progressBar.style.width = '100%';
                return;
            }
            const percentage = (currentTime / maxModeTime) * 100;
            progressBar.style.width = `${percentage}%`;
        }

        function tick() {
            totalSeconds++;
            totalTimeDisplay.textContent = formatTime(totalSeconds);

            if (currentTime === 1) {
                // If TTS is disabled, play beep. If TTS enabled, stay silent (speak() handles it in setMode)
                if (!settings.ttsEnabled) {
                    playTone('end');
                }
                
                if (mode === 'prep') {
                    setMode('work');
                } else if (mode === 'work') {
                    setMode('rest');
                } else if (mode === 'rest') {
                    totalSets++;
                    setCounter.textContent = totalSets;
                    setMode('work');
                }
            } else if (currentTime > 1) {
                currentTime--;
                updateDisplay();
                updateProgressBar();
                
                if (currentTime <= 3) {
                    playTone(mode === 'prep' ? 'prep' : 'tick');
                }
            }
        }

        async function toggleTimer() {
            initAudio();
            
            if (isRunning) {
                // Pause
                clearInterval(timer);
                if (ttsTimeout) clearTimeout(ttsTimeout);
                isRunning = false;
                await releaseWakeLock();
                settingsBtn.disabled = false;
                if(window.speechSynthesis) window.speechSynthesis.cancel();

                startBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg> ç¹¼çºŒ`;
                startBtn.classList.replace('bg-amber-600', 'bg-emerald-600');
                startBtn.classList.replace('hover:bg-amber-500', 'hover:bg-emerald-500');

            } else {
                // Start
                settingsBtn.disabled = true;
                await requestWakeLock();

                if (mode === 'idle') {
                    totalSets = 1;
                    setCounter.textContent = totalSets;
                    if (settings.prepEnabled) setMode('prep');
                    else setMode('work');
                } else {
                    if(settings.ttsEnabled) speak("ç¹¼çºŒ");
                }

                isRunning = true;
                timer = setInterval(tick, 1000);

                startBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg> æš«åœ`;
                startBtn.classList.replace('bg-emerald-600', 'bg-amber-600');
                startBtn.classList.replace('hover:bg-emerald-500', 'hover:bg-amber-500');
            }
        }

        async function resetApp() {
            clearInterval(timer);
            if (ttsTimeout) clearTimeout(ttsTimeout);
            isRunning = false;
            await releaseWakeLock();
            settingsBtn.disabled = false;
            if(window.speechSynthesis) window.speechSynthesis.cancel();

            mode = 'idle';
            setMode('idle'); 
            
            currentTime = settings.workTime;
            maxModeTime = settings.workTime; 
            totalSets = 1;
            setCounter.textContent = totalSets;
            totalSeconds = 0;
            totalTimeDisplay.textContent = "00:00";
            
            updateDisplay();
            updateProgressBar();
            
            startBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg> é–‹å§‹`;
            startBtn.classList.replace('bg-amber-600', 'bg-emerald-600');
            startBtn.classList.replace('hover:bg-amber-500', 'hover:bg-emerald-500');
        }

        function updateMuteIcon() {
            if (settings.soundEnabled) {
                soundOnIcon.classList.remove('hidden');
                soundOffIcon.classList.add('hidden');
            } else {
                soundOnIcon.classList.add('hidden');
                soundOffIcon.classList.remove('hidden');
            }
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', toggleTimer);
        timerDisplay.addEventListener('click', toggleTimer);
        resetBtn.addEventListener('click', resetApp);
        
        muteBtn.addEventListener('click', () => {
            settings.soundEnabled = !settings.soundEnabled;
            updateMuteIcon();
            saveSettings(); 
        });

        // Test Voice Button
        testVoiceBtn.addEventListener('click', () => {
             doSpeak("é€™æ˜¯ä¸€æ®µèªéŸ³æ¸¬è©¦ï¼Œå¦‚æœæ‚¨è½å¾—åˆ°è²éŸ³ï¼Œè¡¨ç¤ºè¨­å®šæ­£å¸¸ã€‚");
        });

        // Settings Modal
        settingsBtn.addEventListener('click', () => {
            applySettingsToInputs();
            settingsModal.classList.remove('hidden');
        });
        closeSettingsBtn.addEventListener('click', () => {
            loadSettings(); 
            settingsModal.classList.add('hidden');
        });
        saveSettingsBtn.addEventListener('click', async () => {
            saveSettings();
            await resetApp();
            settingsModal.classList.add('hidden');
        });
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                loadSettings();
                settingsModal.classList.add('hidden');
            }
        });

        // Preset Handlers
        loadPresetBtn.addEventListener('click', () => {
            const index = presetSelect.value;
            const allPresets = [...DEFAULT_PRESETS, ...settings.customPresets];
            const selected = allPresets[index];
            if (selected) {
                workInput.value = selected.workTime;
                restInput.value = selected.restTime;
                prepToggle.checked = selected.prepEnabled;
                exerciseListInput.value = selected.exercises.join('\n');
                alert(`å·²è®€å–æ¨¡å¼ï¼š${selected.name}`);
            }
        });

        savePresetBtn.addEventListener('click', () => {
            const name = newPresetName.value.trim();
            if (!name) {
                alert('è«‹è¼¸å…¥æ¨¡å¼åç¨±');
                return;
            }
            
            const newPreset = {
                name: name,
                workTime: parseInt(workInput.value) || 30,
                restTime: parseInt(restInput.value) || 10,
                prepEnabled: prepToggle.checked,
                exercises: exerciseListInput.value.trim().split('\n').map(s=>s.trim()).filter(s=>s)
            };
            
            settings.customPresets.push(newPreset);
            localStorage.setItem('timerSettings_v2', JSON.stringify(settings));
            updatePresetList();
            presetSelect.value = DEFAULT_PRESETS.length + settings.customPresets.length - 1;
            newPresetName.value = '';
            alert(`å·²å„²å­˜æ¨¡å¼ï¼š${name}`);
        });

        deletePresetBtn.addEventListener('click', () => {
            const index = presetSelect.value;
            const option = presetSelect.options[presetSelect.selectedIndex];
            
            if (option.dataset.type === 'custom') {
                if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${option.text}ã€å—ï¼Ÿ`)) {
                    const customIndex = parseInt(option.dataset.customIndex);
                    settings.customPresets.splice(customIndex, 1);
                    localStorage.setItem('timerSettings_v2', JSON.stringify(settings));
                    updatePresetList();
                }
            } else {
                alert('ç„¡æ³•åˆªé™¤å…§å»ºé è¨­æ¨¡å¼');
            }
        });

        loadSettings();

    </script>
</body>
</html>