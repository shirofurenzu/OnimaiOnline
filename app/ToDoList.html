<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾…è¾¦æ¸…å–® Pro v10</title>
    <link rel="icon" href="../images/brother.png" type="image/png">
    <style>
        /* --- å…¨åŸŸè®Šæ•¸ --- */
        :root {
            --bg-color: #f0f2f5;
            --sidebar-bg: #ffffff;
            --main-bg: #ffffff;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --primary-color: #0984e3;
            --accent-color: #6c5ce7;
            --danger-color: #ff7675;
            --success-color: #00b894;
            --warning-color: #f39c12;
            --border-color: #dfe6e9;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --input-bg: #f5f6fa;
            --modal-overlay: rgba(0,0,0,0.5);
            --toast-bg: #2d3436;

            /* ä»»å‹™åº•è‰² (æ·ºè‰²æ¨¡å¼) - é è¨­æ”¹ç‚ºæ·ºç° */
            --task-bg-default: #f5f5f5; 
            --task-bg-red: #ffe5e5;   /* é€¾æœŸç´… */
            --task-bg-orange: #fff5cc; /* ç•¶æ—¥æ©˜ */
            --task-bg-green: #e8f5e9;
            --task-bg-blue: #e3f2fd;
            --task-bg-purple: #f3e5f5;
            --task-bg-gray: #e0e0e0; /* æ‰‹å‹•é¸çš„ç°è¦å†æ·±ä¸€é» */
        }

        body.dark-mode {
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --main-bg: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #aaaaaa;
            --primary-color: #90caf9;
            --border-color: #333333;
            --input-bg: #2c2c2c;
            --shadow: 0 4px 6px rgba(0,0,0,0.5);
            --modal-overlay: rgba(0,0,0,0.8);
            --toast-bg: #ffffff;

            /* ä»»å‹™åº•è‰² (æ·±è‰²æ¨¡å¼) */
            --task-bg-default: #2a2a2a; /* æ¯”èƒŒæ™¯ç¨äº® */
            --task-bg-red: #3e2020;
            --task-bg-orange: #3e3015;
            --task-bg-green: #1b3320;
            --task-bg-blue: #1a2f3d;
            --task-bg-purple: #2f1d33;
            --task-bg-gray: #444444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            height: 100dvh; 
            display: flex;
            justify-content: center;
            padding: 15px;
            overflow: hidden;
            transition: background 0.3s;
        }

        .app-container {
            width: 100%;
            max-width: 1400px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        header { margin-bottom: 10px; flex-shrink: 0; text-align: center; }
        h2 { color: var(--primary-color); font-weight: 800; font-size: 1.5rem; }
        
        #fileStatus { font-size: 12px; color: var(--text-secondary); margin-top: 5px; height: 18px; }
        #fileStatus.saved { color: var(--success-color); }
        #fileStatus.unsaved { color: var(--danger-color); font-weight: bold; }

        .layout-grid {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 15px;
            overflow: hidden;
            min-height: 0;
        }

        /* --- å·¦å´æ§åˆ¶é¢æ¿ --- */
        .control-panel {
            background: var(--sidebar-bg);
            padding: 15px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            flex-shrink: 0;
            max-height: 40%;
            overflow-y: auto;
        }

        .panel-section { margin-bottom: 15px; }
        .panel-title { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; font-weight: bold; text-transform: uppercase; }

        input, select, textarea {
            padding: 10px;
            border: 2px solid var(--border-color);
            background: var(--input-bg);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-primary);
            outline: none;
            width: 100%;
            transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); }

        .input-stack { display: flex; flex-direction: column; gap: 8px; }
        .input-row { display: flex; gap: 8px; }

        .btn {
            border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 14px;
        }
        .btn-primary { background: var(--primary-color); color: white; width: 100%; }
        .btn-primary:hover { filter: brightness(1.1); }
        
        .btn-file { background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-file:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .btn-save-file { background: var(--success-color); color: white; }
        .btn-save-file:hover { filter: brightness(1.1); }
        
        .btn-tool { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); font-size: 12px; padding: 6px; }
        .btn-tool:hover { border-color: var(--primary-color); color: var(--primary-color); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .stat-card { background: var(--input-bg); padding: 8px; border-radius: 6px; text-align: center; }
        .stat-num { font-size: 16px; font-weight: bold; color: var(--primary-color); display: block; }
        .stat-label { font-size: 10px; color: var(--text-secondary); }

        /* --- å³å´æ¸…å–®å€åŸŸ --- */
        .list-panel {
            background: var(--main-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1;
            min-height: 0;
        }

        .list-header {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
            background: var(--main-bg);
            z-index: 10;
        }

        .filter-row { display: flex; justify-content: space-between; align-items: center; }
        .filter-tabs { display: flex; gap: 5px; }
        .tab-btn {
            background: none; border: none; font-size: 14px; font-weight: bold; color: var(--text-secondary);
            cursor: pointer; padding: 4px 10px; border-radius: 20px; transition: 0.3s;
        }
        .tab-btn.active { background: var(--input-bg); color: var(--primary-color); }

        .search-box { position: relative; width: 100%; }
        .search-box input { padding-left: 32px; border-radius: 20px; padding-top: 8px; padding-bottom: 8px;}
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 14px; }

        ul#taskList {
            list-style: none;
            overflow-y: auto;
            flex-grow: 1;
            padding: 0 15px;
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
        }

        /* ä»»å‹™å¡ç‰‡åº•è‰²æ¨£å¼ */
        .task-item {
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid transparent;
            cursor: grab;
            position: relative;
            background-color: var(--task-bg-default); /* ä½¿ç”¨ç°è‰² */
            transition: background-color 0.3s, box-shadow 0.2s;
        }
        
        /* é¡è‰²é¡åˆ¥ */
        .task-item.bg-red { background-color: var(--task-bg-red); border-left: 4px solid #ff5252; }
        .task-item.bg-orange { background-color: var(--task-bg-orange); border-left: 4px solid #ffb74d; }
        .task-item.bg-green { background-color: var(--task-bg-green); }
        .task-item.bg-blue { background-color: var(--task-bg-blue); }
        .task-item.bg-purple { background-color: var(--task-bg-purple); }
        .task-item.bg-gray { background-color: var(--task-bg-gray); }

        .task-item:active { cursor: grabbing; }
        .task-item.dragging { opacity: 0.4; border: 2px dashed var(--primary-color); }

        .task-header { display: flex; align-items: flex-start; gap: 10px; }
        
        .checkbox {
            width: 22px; height: 22px; border: 2px solid var(--text-secondary); border-radius: 6px;
            cursor: pointer; display: grid; place-items: center; flex-shrink: 0; margin-top: 2px;
            background: rgba(255,255,255,0.8); /* èƒŒæ™¯åŠ æ·±ä¸€é»ï¼Œå› ç‚ºå¡ç‰‡è®Šç°äº† */
        }
        .task-item.completed .checkbox { background: var(--success-color); border-color: var(--success-color); }
        .task-item.completed .checkbox::after { content: 'âœ“'; color: white; font-weight: bold; font-size: 14px; }
        .task-item.completed .task-title { text-decoration: line-through; opacity: 0.6; }

        .task-content { flex: 1; min-width: 0; }
        .task-title { font-size: 15px; font-weight: 500; margin-bottom: 4px; line-height: 1.4; word-break: break-all; }
        
        .task-meta { font-size: 11px; color: var(--text-secondary); display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        
        .tag { padding: 2px 5px; border-radius: 4px; font-weight: bold; color: white; font-size: 10px; }
        .tag.high { background: var(--danger-color); }
        .tag.mid { background: var(--warning-color); }
        .tag.low { background: var(--success-color); }
        .cat-tag { padding: 2px 5px; border-radius: 4px; font-size: 10px; background: rgba(0,0,0,0.1); color: var(--text-primary); }

        .task-date.overdue { color: var(--danger-color); font-weight: bold; }
        .task-date.today { color: #e67e22; font-weight: bold; }
        .has-notes { color: var(--accent-color); font-size: 12px; display: inline-flex; align-items: center; gap: 2px; }

        .task-actions { display: flex; gap: 2px; flex-shrink: 0; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 16px; padding: 6px; opacity: 0.5; transition: 0.2s; color: var(--text-secondary); }
        .btn-icon:hover { opacity: 1; transform: scale(1.1); color: var(--primary-color); }
        .btn-del:hover { color: var(--danger-color); }

        .btn-collapse {
            font-size: 11px; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.05); 
            cursor: pointer; margin-left: auto; transition: 0.2s; display: inline-flex; align-items: center; gap: 4px;
        }
        .btn-collapse:hover { background: rgba(0,0,0,0.1); }
        .btn-collapse.collapsed .arrow { transform: rotate(-90deg); }
        .arrow { transition: transform 0.2s; display: inline-block; }

        .subtasks-wrapper {
            margin-top: 8px; padding-left: 32px; overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 2000px; opacity: 1;
        }
        .subtasks-wrapper.hidden { max-height: 0; opacity: 0; margin-top: 0; }

        .task-note-view {
            font-size: 13px; color: var(--text-secondary); background: rgba(255,255,255,0.4);
            padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;
            white-space: pre-wrap; border-left: 3px solid var(--accent-color); line-height: 1.5;
        }
        .task-note-view a { color: var(--primary-color); text-decoration: underline; }

        .progress-container { margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
        .progress-bar-bg { flex: 1; height: 5px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.3s; }
        .progress-text { font-size: 10px; color: var(--text-secondary); }

        .subtask-row { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; cursor: pointer;}
        .sub-check { width: 14px; height: 14px; border: 1px solid var(--text-secondary); border-radius: 3px; display: grid; place-items: center; }
        .subtask-row.done .sub-check { background: var(--success-color); border-color: var(--success-color); }
        .subtask-row.done span { text-decoration: line-through; opacity: 0.7; }

        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--toast-bg); color: var(--bg-color);
            padding: 10px 20px; border-radius: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 15px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000; font-weight: bold; font-size: 14px; white-space: nowrap;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }
        #undoBtn { background: none; border: none; color: var(--accent-color); font-weight: bold; cursor: pointer; text-transform: uppercase; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-overlay); display: none; justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: var(--sidebar-bg); width: 95%; max-width: 500px; max-height: 85vh;
            border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-weight: bold; font-size: 18px; }
        .modal-body { overflow-y: auto; flex: 1; padding-right: 5px; }
        
        .color-picker { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .color-option {
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent; transition: transform 0.2s;
        }
        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border-color: var(--text-primary); transform: scale(1.1); box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        
        .co-default { background: linear-gradient(135deg, #f5f5f5 50%, #e0e0e0 50%); border: 1px solid #ccc; }
        .co-red { background: #ffcdd2; }
        .co-orange { background: #ffe0b2; }
        .co-green { background: #c8e6c9; }
        .co-blue { background: #bbdefb; }
        .co-purple { background: #e1bee7; }
        .co-gray { background: #cfcfcf; }

        .subtask-edit-list { list-style: none; margin-top: 10px; }
        .subtask-edit-item { 
            display: flex; gap: 10px; margin-bottom: 12px; align-items: center; 
            background: var(--input-bg); padding: 8px; border-radius: 8px;
            border: 1px solid transparent;
        }
        .subtask-edit-item.dragging { opacity: 0.5; border: 1px dashed var(--primary-color); }
        .drag-handle { cursor: grab; color: var(--text-secondary); font-size: 18px; padding: 0 5px; }
        .subtask-input { 
            flex: 1; min-width: 0; padding: 8px; font-size: 15px; border: none; 
            background: transparent; border-bottom: 1px solid var(--border-color); border-radius: 0;
        }
        .subtask-input:focus { border-bottom-color: var(--primary-color); }
        .btn-sub-del { color: var(--danger-color); font-size: 20px; cursor: pointer; border: none; background: none; padding: 0 5px; }

        .modal-footer { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        .btn-cancel { background: #eee; color: #555; }
        .btn-save { background: var(--primary-color); color: white; }

        textarea { resize: vertical; min-height: 80px; }

        @media (min-width: 768px) {
            body { padding: 20px; }
            .app-container { max-width: 1400px; }
            .layout-grid { 
                display: grid; 
                grid-template-columns: 320px 1fr; 
                gap: 20px;
                overflow: hidden; 
                height: 100%; 
                padding-bottom: 20px; 
            }
            .control-panel { max-height: 100%; margin-bottom: 0; }
            .list-panel { height: 100%; margin-top: 0; }
            ul#taskList { padding: 0 20px 20px 20px; padding-bottom: 20px; }
            .task-actions { gap: 5px; }
            .list-header { padding: 15px; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h2>âœ¨ å¾…è¾¦æ¸…å–® Pro v10</h2>
        <div id="fileStatus">å°šæœªé–‹å•Ÿæª”æ¡ˆ (ä½¿ç”¨æœ¬æ©Ÿå¿«å–)</div>
    </header>

    <div class="layout-grid">
        <!-- å·¦å´é¢æ¿ -->
        <aside class="control-panel">
            <div class="panel-section">
                <div class="panel-title">æª”æ¡ˆç®¡ç†</div>
                <div class="input-stack">
                    <button class="btn btn-file" onclick="openLocalFile()">ğŸ“‚ é–‹å•ŸèˆŠæª” (todo.json)</button>
                    <button class="btn btn-save-file" onclick="saveToLocalFile()">ğŸ’¾ å„²å­˜è®Šæ›´ (Ctrl+S)</button>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">å¿«é€Ÿæ–°å¢</div>
                <div class="input-stack">
                    <input type="text" id="newInput" placeholder="è¼¸å…¥ä»»å‹™åç¨± (Enter)...">
                    <div class="input-row">
                        <select id="newCategory">
                            <option value="Work">ğŸ’¼ å·¥ä½œ</option>
                            <option value="Personal">ğŸ  å€‹äºº</option>
                            <option value="Study">ğŸ“š å­¸ç¿’</option>
                            <option value="Other">ğŸ“¦ å…¶ä»–</option>
                        </select>
                        <select id="newPriority">
                            <option value="high">é«˜</option>
                            <option value="mid" selected>ä¸­</option>
                            <option value="low">ä½</option>
                        </select>
                    </div>
                    <input type="date" id="newDate">
                    <button class="btn btn-primary" onclick="addNewTask()">ï¼‹ æ–°å¢ä»»å‹™</button>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">é€²åº¦ç¸½è¦½</div>
                <div class="stats-grid">
                    <div class="stat-card"><span class="stat-num" id="statTotal">0</span><span class="stat-label">ç¸½æ•¸</span></div>
                    <div class="stat-card"><span class="stat-num" id="statDone" style="color:var(--success-color)">0</span><span class="stat-label">å·²å®Œæˆ</span></div>
                </div>
            </div>

            <div class="panel-section" style="margin-bottom:0;">
                <div class="panel-title">è¨­å®š</div>
                <div class="input-stack">
                    <button class="btn btn-tool" onclick="exportData()">ğŸ“¤ å¦å­˜æ–°æª” (åŒ¯å‡º)</button>
                    <button class="btn btn-tool" onclick="toggleTheme()">ğŸŒ— åˆ‡æ›æ¨¡å¼</button>
                    <a href="../index.html" class="btn btn-tool" style="text-decoration:none; display:flex; align-items:center; justify-content:center;">ğŸ  å›é¦–é </a>
                </div>
            </div>
        </aside>

        <!-- å³å´æ¸…å–® -->
        <main class="list-panel">
            <div class="list-header">
                <div class="filter-row">
                    <div class="filter-tabs">
                        <button class="tab-btn" onclick="setFilter('all', this)">å…¨éƒ¨</button>
                        <button class="tab-btn active" onclick="setFilter('active', this)">é€²è¡Œä¸­</button>
                        <button class="tab-btn" onclick="setFilter('completed', this)">å·²å®Œæˆ</button>
                    </div>
                </div>
                <div class="search-box" style="margin-top:10px;">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="searchInput" placeholder="æœå°‹ä»»å‹™..." oninput="render()">
                </div>
            </div>
            
            <ul id="taskList">
                <!-- JS ç”Ÿæˆ -->
            </ul>
        </main>
    </div>
</div>

<!-- æ’¤éŠ·é€šçŸ¥ -->
<div id="toast">
    <span id="toastMsg">å·²åˆªé™¤ä»»å‹™</span>
    <button id="undoBtn" onclick="undoDelete()">å¾©åŸ</button>
</div>

<!-- ç·¨è¼¯è¦–çª— -->
<div class="modal-overlay" id="editModal">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title">ç·¨è¼¯ä»»å‹™</div>
            <button onclick="closeModal()" style="border:none;background:none;font-size:24px;cursor:pointer;color:var(--text-secondary)">Ã—</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editId">
            <div class="panel-title">åŸºæœ¬è³‡è¨Š</div>
            <input type="text" id="editTitle" style="margin-bottom:10px; font-weight:bold;">
            <div class="input-row" style="margin-bottom:10px;">
                <select id="editCategory">
                    <option value="Work">ğŸ’¼ å·¥ä½œ</option>
                    <option value="Personal">ğŸ  å€‹äºº</option>
                    <option value="Study">ğŸ“š å­¸ç¿’</option>
                    <option value="Other">ğŸ“¦ å…¶ä»–</option>
                </select>
                <select id="editPriority">
                    <option value="high">é«˜</option>
                    <option value="mid">ä¸­</option>
                    <option value="low">ä½</option>
                </select>
                <input type="date" id="editDate">
            </div>

            <!-- åº•è‰²é¸æ“‡ (å¢åŠ èªªæ˜) -->
            <div class="panel-title">å¡ç‰‡åº•è‰² (é¸ç¬¬ä¸€é¡†ç‚ºè‡ªå‹•åˆ¤æ–·)</div>
            <div class="color-picker" id="colorPicker">
                <div class="color-option co-default" title="è‡ªå‹• (é€¾æœŸè®Šç´…/ç•¶æ—¥è®Šæ©˜)" data-color="default" onclick="selectColor('default')"></div>
                <div class="color-option co-red" data-color="bg-red" onclick="selectColor('bg-red')"></div>
                <div class="color-option co-orange" data-color="bg-orange" onclick="selectColor('bg-orange')"></div>
                <div class="color-option co-green" data-color="bg-green" onclick="selectColor('bg-green')"></div>
                <div class="color-option co-blue" data-color="bg-blue" onclick="selectColor('bg-blue')"></div>
                <div class="color-option co-purple" data-color="bg-purple" onclick="selectColor('bg-purple')"></div>
                <div class="color-option co-gray" data-color="bg-gray" onclick="selectColor('bg-gray')"></div>
            </div>
            <input type="hidden" id="editColor">

            <div class="panel-title">è©³ç´°å‚™è¨»</div>
            <textarea id="editNotes" placeholder="è¼¸å…¥è©³ç´°èªªæ˜ã€ç¶²å€æˆ–ç­†è¨˜..." style="margin-bottom:15px;"></textarea>

            <div class="panel-title">å­ä»»å‹™æ¸…å–® (å¯æ‹–æ›³)</div>
            <ul class="subtask-edit-list" id="editSubtaskList"></ul>
            <button class="btn btn-tool" style="width:100%; margin-top:10px; border-style:dashed;" onclick="addSubtaskInModal()">ï¼‹ æ–°å¢å­ä»»å‹™</button>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="saveEdit()">å„²å­˜è®Šæ›´</button>
        </div>
    </div>
</div>

<script>
    let tasks = [];
    let currentFilter = 'active'; // é è¨­æ”¹ç‚º é€²è¡Œä¸­
    let deletedTaskStack = null;
    let toastTimeout = null;
    const STORAGE_KEY = 'todo_pro_v10_data';
    const THEME_KEY = 'todo_pro_theme';
    let fileHandle = null; 
    let hasUnsavedChanges = false;

    window.onload = function() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) tasks = JSON.parse(saved);
        
        const theme = localStorage.getItem(THEME_KEY);
        if (theme === 'dark') document.body.classList.add('dark-mode');

        document.getElementById('newDate').valueAsDate = new Date();
        document.getElementById('newInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addNewTask();
        });
        
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveToLocalFile();
            }
        });
        
        window.addEventListener('beforeunload', function (e) {
            if (hasUnsavedChanges) {
                e.preventDefault(); e.returnValue = '';
            }
        });

        initListDrag();
        render();
    };

    async function openLocalFile() {
        try {
            [fileHandle] = await window.showOpenFilePicker({
                types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }],
            });
            const file = await fileHandle.getFile();
            const contents = await file.text();
            try {
                tasks = JSON.parse(contents);
                saveData(false);
                hasUnsavedChanges = false;
                render();
                updateFileStatus('å·²é–‹å•Ÿ: ' + file.name, 'saved');
            } catch(e) { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
        } catch (err) {}
    }

    async function saveToLocalFile() {
        if (!fileHandle) return exportData();
        try {
            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(tasks));
            await writable.close();
            hasUnsavedChanges = false;
            updateFileStatus('å„²å­˜æˆåŠŸï¼ ' + new Date().toLocaleTimeString(), 'saved');
        } catch (err) {
            alert('å„²å­˜å¤±æ•—');
            updateFileStatus('å„²å­˜å¤±æ•—', 'unsaved');
        }
    }

    function updateFileStatus(msg, type) {
        const el = document.getElementById('fileStatus');
        el.innerText = msg;
        el.className = type;
        if(type === 'unsaved') el.innerText += ' (æœ‰è®Šæ›´æœªå­˜æª”)';
    }

    function saveData(isUserEdit = true) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        updateStats();
        if(isUserEdit) {
            hasUnsavedChanges = true;
            if(fileHandle) updateFileStatus('æœ‰è®Šæ›´æœªå­˜æª” (è«‹æŒ‰å„²å­˜)', 'unsaved');
        }
    }

    function addNewTask() {
        const input = document.getElementById('newInput');
        const date = document.getElementById('newDate');
        const pri = document.getElementById('newPriority');
        const cat = document.getElementById('newCategory');
        
        if (!input.value.trim()) return alert('è«‹è¼¸å…¥å…§å®¹');

        tasks.push({
            id: Date.now(),
            text: input.value,
            date: date.value,
            priority: pri.value,
            category: cat.value,
            note: '',
            color: 'default', 
            completed: false,
            isCollapsed: false,
            subtasks: []
        });

        input.value = '';
        saveData();
        render();
        const list = document.getElementById('taskList');
        setTimeout(() => list.scrollTop = list.scrollHeight, 50);
    }

    function duplicateTask(id) {
        const index = tasks.findIndex(x => x.id === id);
        if (index > -1) {
            const newTask = JSON.parse(JSON.stringify(tasks[index]));
            newTask.id = Date.now();
            newTask.text += " (å‰¯æœ¬)";
            tasks.splice(index + 1, 0, newTask);
            saveData();
            render();
        }
    }

    function toggleTask(id) {
        const t = tasks.find(x => x.id === id);
        if(t) { t.completed = !t.completed; saveData(); render(); }
    }
    
    function toggleSubtaskView(id) {
        const t = tasks.find(x => x.id === id);
        if(t) { t.isCollapsed = !t.isCollapsed; saveData(); render(); }
    }

    function toggleSubtaskStatus(taskId, subIndex) {
        const t = tasks.find(x => x.id === taskId);
        if(t && t.subtasks[subIndex]) {
            t.subtasks[subIndex].completed = !t.subtasks[subIndex].completed;
            saveData();
            render();
        }
    }

    function deleteTask(id) {
        const index = tasks.findIndex(x => x.id === id);
        if(index > -1) {
            deletedTaskStack = { task: tasks[index], index: index };
            tasks.splice(index, 1);
            saveData();
            render();
            showToast('å·²åˆªé™¤ä»»å‹™');
        }
    }

    function undoDelete() {
        if(deletedTaskStack) {
            tasks.splice(deletedTaskStack.index, 0, deletedTaskStack.task);
            deletedTaskStack = null;
            saveData();
            render();
            hideToast();
        }
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        document.getElementById('toastMsg').innerText = msg;
        toast.classList.add('show');
        if(toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(hideToast, 4000);
    }

    function hideToast() { document.getElementById('toast').classList.remove('show'); }

    function initListDrag() {
        const container = document.getElementById('taskList');
        container.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(container, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (!draggable) return;
            if (afterElement == null) container.appendChild(draggable);
            else container.insertBefore(draggable, afterElement);
        });

        container.addEventListener('drop', e => {
            e.preventDefault();
            const newOrderIds = Array.from(container.querySelectorAll('.task-item')).map(item => Number(item.getAttribute('data-id')));
            const newTasks = [];
            newOrderIds.forEach(id => {
                const t = tasks.find(x => x.id === id);
                if(t) newTasks.push(t);
            });
            const currentIds = tasks.map(t => t.id);
            const hiddenTasks = tasks.filter(t => !newOrderIds.includes(t.id) && !isTaskVisibleInCurrentFilter(t)); 
            
            if(newTasks.length + hiddenTasks.length === tasks.length) {
                tasks = [...newTasks, ...hiddenTasks];
            } else {
                 tasks = newTasks; 
                 const renderedIds = newTasks.map(t => t.id);
                 const missing = currentIds.filter(id => !renderedIds.includes(id)).map(id => tasks.find(t => t.id === id));
                 tasks.push(...missing);
            }
            saveData();
            render();
        });
    }
    
    function isTaskVisibleInCurrentFilter(t) {
        if(currentFilter === 'active' && t.completed) return false;
        if(currentFilter === 'completed' && !t.completed) return false;
        const search = document.getElementById('searchInput').value.toLowerCase();
        if(search && !t.text.toLowerCase().includes(search)) return false;
        return true;
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
            else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    let currentEditSubtasks = [];
    function openEditModal(id) {
        const t = tasks.find(x => x.id === id);
        if(!t) return;
        document.getElementById('editId').value = t.id;
        document.getElementById('editTitle').value = t.text;
        document.getElementById('editDate').value = t.date;
        document.getElementById('editPriority').value = t.priority;
        document.getElementById('editCategory').value = t.category || 'Other';
        document.getElementById('editNotes').value = t.note || '';
        
        selectColor(t.color || 'default');

        currentEditSubtasks = JSON.parse(JSON.stringify(t.subtasks || []));
        renderEditSubtasks();
        document.getElementById('editModal').classList.add('active');
    }
    function closeModal() { document.getElementById('editModal').classList.remove('active'); }

    function selectColor(colorClass) {
        document.getElementById('editColor').value = colorClass;
        document.querySelectorAll('.color-option').forEach(opt => {
            opt.classList.remove('selected');
            if(opt.dataset.color === colorClass) opt.classList.add('selected');
        });
    }

    function renderEditSubtasks() {
        const list = document.getElementById('editSubtaskList');
        list.innerHTML = '';
        currentEditSubtasks.forEach((sub, index) => {
            const li = document.createElement('li');
            li.className = 'subtask-edit-item';
            li.draggable = true;
            li.dataset.index = index;
            li.addEventListener('dragstart', () => li.classList.add('dragging'));
            li.addEventListener('dragend', () => { li.classList.remove('dragging'); renderEditSubtasks(); });
            li.addEventListener('dragover', e => {
                e.preventDefault();
                const draggingItem = list.querySelector('.dragging');
                if(draggingItem !== li) {
                     const srcIdx = Number(draggingItem.dataset.index);
                     const targetIdx = Number(li.dataset.index);
                     const [moved] = currentEditSubtasks.splice(srcIdx, 1);
                     currentEditSubtasks.splice(targetIdx, 0, moved);
                     if(srcIdx < targetIdx) list.insertBefore(draggingItem, li.nextSibling);
                     else list.insertBefore(draggingItem, li);
                }
            });
            li.innerHTML = `
                <div class="drag-handle">â‰¡</div>
                <input type="checkbox" style="width:20px;" ${sub.completed ? 'checked' : ''} onchange="updateSubStatus(${index}, this.checked)">
                <input type="text" class="subtask-input" value="${sub.text}" placeholder="è¼¸å…¥å­ä»»å‹™..." oninput="updateSubText(${index}, this.value)">
                <button class="btn-sub-del" onclick="removeSubtaskInModal(${index})">Ã—</button>
            `;
            list.appendChild(li);
        });
    }
    function addSubtaskInModal() { currentEditSubtasks.push({ id: Date.now(), text: '', completed: false }); renderEditSubtasks(); }
    function removeSubtaskInModal(index) { currentEditSubtasks.splice(index, 1); renderEditSubtasks(); }
    function updateSubText(index, val) { currentEditSubtasks[index].text = val; }
    function updateSubStatus(index, checked) { currentEditSubtasks[index].completed = checked; }
    function saveEdit() {
        const id = Number(document.getElementById('editId').value);
        const t = tasks.find(x => x.id === id);
        if(t) {
            t.text = document.getElementById('editTitle').value;
            t.date = document.getElementById('editDate').value;
            t.priority = document.getElementById('editPriority').value;
            t.category = document.getElementById('editCategory').value;
            t.note = document.getElementById('editNotes').value;
            t.color = document.getElementById('editColor').value; 
            t.subtasks = currentEditSubtasks.filter(s => s.text.trim() !== '');
            saveData();
            render();
            closeModal();
        }
    }

    function render() {
        const list = document.getElementById('taskList');
        list.innerHTML = '';
        const today = new Date().toISOString().slice(0, 10);
        const searchText = document.getElementById('searchInput').value.toLowerCase();

        let filtered = tasks.filter(t => {
            if(currentFilter === 'active' && t.completed) return false;
            if(currentFilter === 'completed' && !t.completed) return false;
            if(searchText && !t.text.toLowerCase().includes(searchText)) return false;
            return true;
        });

        if(filtered.length === 0) list.innerHTML = '<div style="text-align:center;padding:20px;color:#999">ç„¡è³‡æ–™ / ç„¡ç¬¦åˆæœå°‹çµæœ</div>';

        filtered.forEach(task => {
            const li = document.createElement('li');
            
            // --- æ™ºæ…§åº•è‰²é‚è¼¯ ---
            let finalColorClass = task.color || 'default';

            if (finalColorClass === 'default' && !task.completed && task.date) {
                if (task.date < today) {
                    finalColorClass = 'bg-red'; 
                } else if (task.date === today) {
                    finalColorClass = 'bg-orange'; 
                }
            }
            
            li.className = `task-item ${task.completed ? 'completed' : ''} ${finalColorClass}`;
            
            li.setAttribute('data-id', task.id);
            li.draggable = true;
            li.addEventListener('dragstart', () => li.classList.add('dragging'));
            li.addEventListener('dragend', () => li.classList.remove('dragging'));

            let priInfo = { cls: 'low', txt: 'ä½' };
            if(task.priority === 'mid') priInfo = { cls: 'mid', txt: 'ä¸­' };
            if(task.priority === 'high') priInfo = { cls: 'high', txt: 'é«˜' };
            
            let catName = 'å…¶ä»–';
            if(task.category === 'Work') catName = 'å·¥ä½œ';
            if(task.category === 'Personal') catName = 'å€‹äºº';
            if(task.category === 'Study') catName = 'å­¸ç¿’';

            let dateDisplay = task.date || '--';
            let dateClass = 'task-date';
            if(task.date && task.date < today && !task.completed) { dateClass += ' overdue'; dateDisplay += ' (å·²é€¾æœŸ)'; }
            else if (task.date === today && !task.completed) { dateClass += ' today'; dateDisplay += ' (ä»Šå¤©)'; }

            const subTotal = task.subtasks ? task.subtasks.length : 0;
            const subDone = task.subtasks ? task.subtasks.filter(s => s.completed).length : 0;
            const hasNotes = task.note && task.note.trim() !== '';
            let noteHtml = hasNotes ? '<span class="has-notes" title="æœ‰å‚™è¨»å…§å®¹">ğŸ“</span>' : '';

            let subHtml = '';
            let collapseBtnHtml = '';
            
            if(subTotal > 0 || hasNotes) {
                const arrow = task.isCollapsed ? 'â–¼' : 'â–²';
                const wrapperClass = task.isCollapsed ? 'subtasks-wrapper hidden' : 'subtasks-wrapper';
                
                let btnText = '';
                if(subTotal > 0) btnText = `<span style="font-size:11px; margin-right:4px;">${subDone}/${subTotal}</span>`;
                else btnText = `<span style="font-size:11px; margin-right:4px;">ğŸ“</span>`;

                collapseBtnHtml = `<div class="btn-collapse ${task.isCollapsed ? 'collapsed' : ''}" onclick="toggleSubtaskView(${task.id})">${btnText}<span class="arrow">${arrow}</span></div>`;
                
                subHtml += `<div class="${wrapperClass}">`;
                if(hasNotes) {
                    const linkedNote = task.note.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
                    subHtml += `<div class="task-note-view">${linkedNote}</div>`;
                }
                if(subTotal > 0) {
                    const progressPercent = Math.round((subDone/subTotal)*100);
                    subHtml += `<div class="progress-container"><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${progressPercent}%"></div></div></div>`;
                    task.subtasks.forEach((s, index) => {
                        subHtml += `<div class="subtask-row ${s.completed ? 'done' : ''}" onclick="toggleSubtaskStatus(${task.id}, ${index})"><div class="sub-check">${s.completed ? 'âœ“' : ''}</div><span>${s.text}</span></div>`;
                    });
                }
                subHtml += `</div>`;
            }

            li.innerHTML = `
                <div class="task-header">
                    <div class="checkbox" onclick="toggleTask(${task.id})"></div>
                    <div class="task-content">
                        <div style="display:flex; align-items:flex-start; justify-content:space-between;">
                            <div class="task-title" onclick="openEditModal(${task.id})">${task.text} ${noteHtml}</div>
                            ${collapseBtnHtml}
                        </div>
                        <div class="task-meta">
                            <span class="cat-tag">${catName}</span>
                            <span class="tag ${priInfo.cls}">${priInfo.txt}å„ªå…ˆ</span>
                            <span class="${dateClass}">ğŸ“… ${dateDisplay}</span>
                        </div>
                        ${subHtml}
                    </div>
                    <div class="task-actions">
                        <button class="btn-icon btn-copy" onclick="duplicateTask(${task.id})" title="è¤‡è£½">â</button>
                        <button class="btn-icon btn-edit" onclick="openEditModal(${task.id})" title="ç·¨è¼¯">âœ</button>
                        <button class="btn-icon btn-del" onclick="deleteTask(${task.id})" title="åˆªé™¤">ğŸ—‘</button>
                    </div>
                </div>
            `;
            list.appendChild(li);
        });
        updateStats();
    }

    function setFilter(type, btn) {
        currentFilter = type;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render();
    }
    function updateStats() {
        document.getElementById('statTotal').innerText = tasks.length;
        document.getElementById('statDone').innerText = tasks.filter(t => t.completed).length;
    }
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem(THEME_KEY, document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }
    async function exportData() {
        const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tasks));
        const a = document.createElement('a');
        a.href = str; a.download = `todo_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }
</script>
</body>
</html>